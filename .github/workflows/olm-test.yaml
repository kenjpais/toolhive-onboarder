name: OLM Test (OKD Compatible)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      catalog_image:
        description: 'Catalog image to use'
        required: false
        default: 'quay.io/kpais/toolhive-test-catalog:latest'

env:
  OPERATOR_NS: toolhive-test-ns
  CATALOG_IMAGE: ${{ github.event.inputs.catalog_image || 'quay.io/kpais/toolhive-test-catalog:latest' }}
  TEST_TIMEOUT: 10m
  CLUSTER_NAME: toolhive-olm-test

jobs:
  olm-test:
    name: OLM Operator Test (OKD Compatible)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}
    
    steps:
      # Phase 2: CI Environment Setup
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Install Chainsaw
        uses: kyverno/action-install-chainsaw@v0.2.13
        with:
          release: v0.2.12
      
      - name: Install OpenShift CLI (oc) for OKD compatibility
        run: |
          set -e
          echo "Installing OpenShift CLI (oc) for OKD compatibility..."
          # Install OpenShift CLI compatible with OKD
          # Try multiple version paths for reliability
          OC_VERSION=4.15
          if ! curl -Lf https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable-${OC_VERSION}/openshift-client-linux.tar.gz -o /tmp/oc.tar.gz 2>/dev/null; then
            if ! curl -Lf https://mirror.openshift.com/pub/openshift-v4/clients/ocp/${OC_VERSION}/openshift-client-linux.tar.gz -o /tmp/oc.tar.gz 2>/dev/null; then
              # Fallback to latest stable
              curl -Lf https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz -o /tmp/oc.tar.gz
            fi
          fi
          tar -xz -C /usr/local/bin -f /tmp/oc.tar.gz
          chmod +x /usr/local/bin/oc
          oc version --client
          echo "OpenShift CLI (oc) installed for OKD compatibility"
      
      - name: Verify kubectl and oc
        run: |
          set -e
          kubectl version --client
          oc version --client
          echo "kubectl and oc are available"
      
      # Phase 3: Cluster Provisioning and OLM Installation
      # Note: Using KIND with OLM installation to simulate OKD environment
      # KIND does not support full OKD distribution, but we simulate OKD by:
      # - Installing OLM (which OKD includes by default)
      # - Using OpenShift CLI (oc) for OKD-compatible operations
      # - Using OKD standard namespaces (openshift-marketplace)
      # In a real OKD cluster, OLM is pre-installed
      - name: Create KIND Cluster
        uses: helm/kind-action@v1.12.0
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          version: v0.29.0
          node_image: kindest/node:v1.32.8
      
      - name: Configure kubectl and oc for KIND
        run: |
          set -e
          kind get kubeconfig --name ${{ env.CLUSTER_NAME }} > ${HOME}/.kube/config
          # Wait for cluster to be ready
          kubectl wait --for=condition=Ready node --all --timeout=120s
          kubectl cluster-info
          oc cluster-info || echo "Note: oc cluster-info may not work with KIND, but oc is available for OKD-compatible operations"
          echo "KIND cluster is ready (using OKD-compatible tooling)"
      
      - name: Install OLM CRDs (OKD includes OLM by default, but installing for KIND)
        run: |
          set -e
          echo "Installing OLM CRDs (simulating OKD environment where OLM is pre-installed)..."
          # Download CRDs file first
          curl -L https://github.com/operator-framework/operator-lifecycle-manager/releases/download/v0.28.0/crds.yaml -o /tmp/olm-crds.yaml
          # Use server-side apply to handle large CRDs with large annotations
          # This bypasses the client-side annotation size limit
          kubectl apply --server-side -f /tmp/olm-crds.yaml || kubectl apply --server-side --force-conflicts -f /tmp/olm-crds.yaml
          echo "OLM CRDs installed successfully"
      
      - name: Install OLM (OKD includes OLM by default, but installing for KIND)
        run: |
          set -e
          echo "Installing OLM components (simulating OKD environment where OLM is pre-installed)..."
          kubectl apply -f https://github.com/operator-framework/operator-lifecycle-manager/releases/download/v0.28.0/olm.yaml
          echo "OLM components installed"
      
      - name: Wait for OLM to be ready (OKD includes OLM by default)
        run: |
          set -e
          echo "Waiting for OLM operator deployment (OKD includes OLM by default)..."
          if ! oc wait --for=condition=available --timeout=5m deployment/olm-operator -n olm; then
            echo "ERROR: OLM operator deployment failed"
            oc get pods -n olm
            oc describe deployment/olm-operator -n olm
            exit 1
          fi
          
          echo "Waiting for catalog operator deployment..."
          if ! oc wait --for=condition=available --timeout=5m deployment/catalog-operator -n olm; then
            echo "ERROR: Catalog operator deployment failed"
            oc get pods -n olm
            oc describe deployment/catalog-operator -n olm
            exit 1
          fi
          
          echo "Waiting for packageserver deployment..."
          if ! oc wait --for=condition=available --timeout=5m deployment/packageserver -n olm; then
            echo "ERROR: Packageserver deployment failed"
            oc get pods -n olm
            oc describe deployment/packageserver -n olm
            exit 1
          fi
          
          echo "OLM is ready (OKD-compatible)"
      
      - name: Create openshift-marketplace namespace (OKD standard namespace)
        run: |
          set -e
          oc create namespace openshift-marketplace --dry-run=client -o yaml | oc apply -f -
          echo "openshift-marketplace namespace created (OKD standard namespace for CatalogSources)"
      
      # Phase 4: Catalog Image Preparation
      - name: Prepare catalog image
        run: |
          set -e
          echo "=========================================="
          echo "Catalog Image Verification"
          echo "=========================================="
          echo "Using catalog image: ${{ env.CATALOG_IMAGE }}"
          echo ""
          echo "NOTE: This step will verify the catalog image contains the 'toolhive-operator'."
          echo "If verification fails, you must rebuild the catalog using the build-catalog workflow."
          echo ""
          
          # Verify image exists and check architecture
          echo "Step 1: Verifying catalog image exists and architecture..."
          if ! docker pull ${{ env.CATALOG_IMAGE }}; then
            echo "ERROR: Failed to pull catalog image: ${{ env.CATALOG_IMAGE }}"
            echo "Please ensure the image exists and is accessible"
            exit 1
          fi
          
          # Check image architecture
          ARCH=$(docker inspect ${{ env.CATALOG_IMAGE }} --format '{{.Architecture}}' || echo "unknown")
          echo "Catalog image architecture: $ARCH"
          
          # Verify it's amd64/x86_64 (required for CI environment)
          if [ "$ARCH" != "amd64" ] && [ "$ARCH" != "x86_64" ]; then
            echo "ERROR: Catalog image architecture is $ARCH, but CI environment requires amd64/x86_64"
            echo "Please rebuild the catalog image for linux/amd64 architecture"
            echo "You can use the build-catalog workflow to rebuild it"
            exit 1
          fi
          
          echo "Catalog image verified (architecture: $ARCH)"
          
          # CRITICAL: Verify catalog contains operator before deploying
          echo "Verifying catalog image contains 'toolhive-operator'..."
          
          # Install opm CLI if not available
          if ! command -v opm &> /dev/null; then
            echo "Installing opm CLI for catalog verification..."
            OPM_VERSION=v1.35.0
            curl -L https://github.com/operator-framework/operator-registry/releases/download/${OPM_VERSION}/linux-amd64-opm -o /tmp/opm
            chmod +x /tmp/opm
            export PATH=/tmp:$PATH
          fi
          
          # CRITICAL: Verify catalog can be rendered and contains the operator
          echo "Rendering catalog image to verify contents..."
          echo "Catalog image: ${{ env.CATALOG_IMAGE }}"
          
          # Capture render output for analysis
          RENDER_OUTPUT=$(opm render ${{ env.CATALOG_IMAGE }} 2>&1 || echo "RENDER_FAILED")
          
          # Check if render failed
          if echo "$RENDER_OUTPUT" | grep -q "RENDER_FAILED\|error\|Error\|ERROR"; then
            echo "ERROR: Failed to render catalog image!"
            echo "opm render output:"
            echo "$RENDER_OUTPUT"
            echo ""
            echo "The catalog image may be corrupted or inaccessible."
            echo "Please rebuild the catalog using the build-catalog workflow."
            exit 1
          fi
          
          # Check if catalog contains toolhive-operator (exact match required)
          if echo "$RENDER_OUTPUT" | grep -q "\"package\":\s*\"toolhive-operator\"\|\"packageName\":\s*\"toolhive-operator\"\|\"name\":\s*\"toolhive-operator"; then
            echo "✓ Catalog image contains 'toolhive-operator' package"
            echo "Sample catalog content:"
            echo "$RENDER_OUTPUT" | grep -i "toolhive-operator\|package" | head -5
          elif echo "$RENDER_OUTPUT" | grep -qi "toolhive-operator"; then
            echo "✓ Catalog image contains 'toolhive-operator' (found in content)"
            echo "Sample catalog content:"
            echo "$RENDER_OUTPUT" | grep -i "toolhive-operator" | head -5
          elif echo "$RENDER_OUTPUT" | grep -q "olm.package\|olm.bundle\|olm.channel"; then
            echo ""
            echo "=========================================="
            echo "ERROR: Catalog contains OLM data but 'toolhive-operator' NOT found!"
            echo "=========================================="
            echo "Catalog image: ${{ env.CATALOG_IMAGE }}"
            echo ""
            echo "The catalog contains OLM metadata but does not include the 'toolhive-operator' package."
            echo "This indicates the catalog was built with a different bundle or is empty."
            echo ""
            echo "Catalog contents (first 30 lines):"
            echo "$RENDER_OUTPUT" | head -30
            echo ""
            echo "All packages found in catalog:"
            echo "$RENDER_OUTPUT" | grep -i "\"package\"" | head -10 || echo "No packages found"
            echo ""
            echo "=========================================="
            echo "SOLUTION:"
            echo "Rebuild the catalog using the build-catalog workflow:"
            echo "  1. Go to Actions → Build Catalog Image → Run workflow"
            echo "  2. Ensure it uses: operator_bundle_image: quay.io/okderators/toolhive-operator-bundle:v0.3.5"
            echo "  3. Wait for the build to complete"
            echo "  4. Re-run this test workflow"
            echo "=========================================="
            exit 1
          else
            echo ""
            echo "=========================================="
            echo "ERROR: Catalog image does not contain valid OLM catalog data!"
            echo "=========================================="
            echo "Catalog image: ${{ env.CATALOG_IMAGE }}"
            echo ""
            echo "The catalog image appears to be empty or corrupted."
            echo ""
            echo "opm render output (first 50 lines):"
            echo "$RENDER_OUTPUT" | head -50
            echo ""
            echo "=========================================="
            echo "SOLUTION:"
            echo "Rebuild the catalog using the build-catalog workflow:"
            echo "  1. Go to Actions → Build Catalog Image → Run workflow"
            echo "  2. Ensure it uses: operator_bundle_image: quay.io/okderators/toolhive-operator-bundle:v0.3.5"
            echo "  3. Wait for the build to complete"
            echo "  4. Re-run this test workflow"
            echo "=========================================="
            exit 1
          fi
          
          echo "Catalog image verified - contains operator and correct architecture"
          echo "Note: Catalog image will be pulled by the cluster when CatalogSource is created"
          echo "If using a local image, it would need to be loaded into KIND:"
          echo "  kind load docker-image ${{ env.CATALOG_IMAGE }} --name ${{ env.CLUSTER_NAME }}"
          echo "Catalog image prepared"
      
      # Phase 5: Declarative OLM Deployment (Helm)
      - name: Create temp-manifests directory
        run: |
          set -e
          mkdir -p temp-manifests
          echo "temp-manifests directory created"
      
      - name: Render Helm chart
        run: |
          set -e
          echo "Rendering Helm chart..."
          if ! helm template toolhive-olm ./toolhive-olm-chart \
            --set catalogSource.image=${{ env.CATALOG_IMAGE }} \
            --set namespace.name=${{ env.OPERATOR_NS }} \
            --set operatorGroup.targetNamespaces[0]=${{ env.OPERATOR_NS }} \
            --set subscription.channel=stable \
            --set subscription.source=toolhive-test-catalog \
            --set subscription.sourceNamespace=openshift-marketplace \
            > temp-manifests/olm-resources.yaml; then
            echo "ERROR: Failed to render Helm chart"
            exit 1
          fi
          echo "Helm chart rendered"
          echo "--- Rendered manifests ---"
          cat temp-manifests/olm-resources.yaml
      
      - name: Split and apply resources in order
        run: |
          set -e
          echo "Splitting resources to apply in correct order..."
          
          # Clean up any existing split files
          rm -f temp-manifests/resource-*.yaml
          
          # Split YAML by document separator using awk (more reliable than csplit)
          # Handle both cases: file starting with --- or not
          awk '
            BEGIN { file=0; content="" }
            /^---$/ {
              if (content != "") {
                print content > "temp-manifests/resource-"file".yaml"
                file++
                content=""
              }
              next
            }
            { content = content $0 "\n" }
            END {
              if (content != "") {
                print content > "temp-manifests/resource-"file".yaml"
              }
            }
          ' temp-manifests/olm-resources.yaml
          
          # Remove empty files
          find temp-manifests -name "resource-*.yaml" -size 0 -delete
          
          echo "Split into $(ls -1 temp-manifests/resource-*.yaml 2>/dev/null | wc -l) resource files"
          
          # Apply CatalogSource first
          echo "Applying CatalogSource first..."
          CATALOG_APPLIED=false
          for file in temp-manifests/resource-*.yaml; do
            [ ! -f "$file" ] && continue
            if grep -q "kind: CatalogSource" "$file" 2>/dev/null; then
              oc apply -f "$file"
              echo "CatalogSource applied from $file"
              CATALOG_APPLIED=true
              break
            fi
          done
          
          if [ "$CATALOG_APPLIED" = "false" ]; then
            echo "WARNING: CatalogSource not found in split files, applying all resources"
            oc apply -f temp-manifests/olm-resources.yaml
          else
            # Apply Namespace and OperatorGroup (but not Subscription yet)
            echo "Applying Namespace and OperatorGroup..."
            for file in temp-manifests/resource-*.yaml; do
              [ ! -f "$file" ] && continue
              if grep -q "kind: Namespace\|kind: OperatorGroup" "$file" 2>/dev/null; then
                oc apply -f "$file" || true
              fi
            done
          fi
          
          echo "Initial resources applied (CatalogSource, Namespace, OperatorGroup)"
      
      - name: Wait for CatalogSource to be READY (OKD standard)
        run: |
          set -e
          echo "Waiting for CatalogSource to be READY (OKD openshift-marketplace namespace)..."
          echo "First, checking if catalog-operator is ready..."
          oc wait --for=condition=available --timeout=2m deployment/catalog-operator -n olm || echo "Warning: catalog-operator might not be fully ready"
          
          echo "Checking CatalogSource status..."
          oc get catalogsource toolhive-test-catalog -n openshift-marketplace -o yaml || echo "CatalogSource not found yet"
          
          echo "Waiting for CatalogSource pod to be created..."
          timeout 120 bash -c 'until oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog 2>/dev/null | grep -q toolhive-test-catalog; do echo "Waiting for catalog pod..."; sleep 5; done' || echo "Catalog pod not created yet"
          
          echo "Checking catalog pod status..."
          oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog || true
          
          # Monitor pod status and fail fast on CrashLoopBackOff
          echo "Monitoring catalog pod status (will fail fast on CrashLoopBackOff)..."
          MAX_WAIT=60  # Wait up to 60 seconds for pod to stabilize
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
          POD_STATUS=$(oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "Unknown")
            RESTART_COUNT=$(oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog -o jsonpath='{.items[0].status.containerStatuses[0].restartCount}' 2>/dev/null || echo "0")
            
          if [ "$POD_STATUS" = "CrashLoopBackOff" ] || [ "$POD_STATUS" = "Error" ]; then
              echo "ERROR: Catalog pod is in $POD_STATUS state (restart count: $RESTART_COUNT)"
              echo "Failing fast to avoid waiting for timeout..."
              
            echo "=== Catalog pod describe ==="
            oc describe pod -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog || true
              
            echo "=== CatalogSource pod logs (all containers) ==="
            oc logs -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog --all-containers=true --tail=100 || true
              
            echo "=== Previous container logs (if any) ==="
            oc logs -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog --previous --tail=100 || true
              
              # Check for architecture mismatch error
              LOGS=$(oc logs -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog --previous --tail=50 2>/dev/null || echo "")
              if echo "$LOGS" | grep -q "exec format error"; then
                echo ""
                echo "=========================================="
                echo "ARCHITECTURE MISMATCH DETECTED!"
                echo "The catalog image appears to be built for the wrong architecture."
                echo "Error: exec format error (typically means ARM image on AMD64 or vice versa)"
                echo ""
                echo "Solution: Rebuild the catalog image for linux/amd64 architecture"
                echo "Use the build-catalog workflow to rebuild:"
                echo "  .github/workflows/build-catalog.yaml"
                echo "=========================================="
              fi
              
            echo "=== Events in openshift-marketplace ==="
            oc get events -n openshift-marketplace --sort-by='.lastTimestamp' | tail -30 || true
              
              exit 1
            fi
            
            # If pod is running or pending, continue waiting
            if [ "$POD_STATUS" = "Running" ] || [ "$POD_STATUS" = "Pending" ] || [ "$POD_STATUS" = "ContainerCreating" ]; then
              echo "Pod status: $POD_STATUS (restart count: $RESTART_COUNT), continuing to wait..."
              sleep 5
              ELAPSED=$((ELAPSED + 5))
            else
              break
          fi
          done
          
          echo "Waiting for CatalogSource to become READY..."
          if ! oc wait --for=jsonpath='{.status.connectionState.lastObservedState}'=READY \
            catalogsource/toolhive-test-catalog -n openshift-marketplace \
            --timeout=${{ env.TEST_TIMEOUT }}; then
            echo "ERROR: CatalogSource did not become READY"
            echo "=== CatalogSource status ==="
            oc get catalogsource toolhive-test-catalog -n openshift-marketplace -o yaml
            echo "=== CatalogSource pods ==="
            oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog
            echo "=== Catalog pod describe ==="
            oc describe pod -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog || true
            echo "=== CatalogSource pod logs (all containers) ==="
            oc logs -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog --all-containers=true --tail=100 || true
            echo "=== Previous container logs (if any) ==="
            oc logs -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog --previous --tail=100 || true
            echo "=== Catalog-operator logs ==="
            oc logs -n olm -l app=catalog-operator --tail=50 || true
            echo "=== Events in openshift-marketplace ==="
            oc get events -n openshift-marketplace --sort-by='.lastTimestamp' | tail -30 || true
            exit 1
          fi
          echo "CatalogSource is READY (OKD-compatible)"
      
      - name: Verify operator exists in catalog
        run: |
          set -e
          echo "Verifying operator 'toolhive-operator' exists in catalog..."
          
          # Wait a bit for catalog to fully index after becoming READY
          echo "Waiting for catalog to fully index (15 seconds)..."
          sleep 15
          
          # Get catalog pod
          CATALOG_POD=$(oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -z "$CATALOG_POD" ]; then
            echo "ERROR: Catalog pod not found"
            exit 1
          fi
          
          echo "Catalog pod: $CATALOG_POD"
          echo "Checking catalog pod is running..."
          oc wait --for=condition=Ready pod/$CATALOG_POD -n openshift-marketplace --timeout=60s || {
            echo "ERROR: Catalog pod not ready"
            exit 1
          }
          
          # Check if catalog database exists (indicates indexing)
          echo "Verifying catalog database exists..."
          DB_FOUND=false
          if oc exec -n openshift-marketplace $CATALOG_POD -- test -f /configs/index.db 2>/dev/null; then
            echo "✓ Catalog database found at /configs/index.db"
            DB_FOUND=true
          elif oc exec -n openshift-marketplace $CATALOG_POD -- test -f /database/index.db 2>/dev/null; then
            echo "✓ Catalog database found at /database/index.db"
            DB_FOUND=true
          else
            echo "ERROR: Catalog database not found!"
            echo "Checking what files exist in the catalog pod:"
            oc exec -n openshift-marketplace $CATALOG_POD -- find / -name "*.db" -type f 2>/dev/null | head -10 || true
            echo "Listing /configs and /database directories:"
            oc exec -n openshift-marketplace $CATALOG_POD -- ls -la /configs /database 2>/dev/null || true
            exit 1
          fi
          
          # CRITICAL: Verify operator package exists in catalog using opm
          echo "Verifying operator package 'toolhive-operator' exists in catalog..."
          
          # Install opm CLI if not available
          if ! command -v opm &> /dev/null; then
            echo "Installing opm CLI for catalog verification..."
            OPM_VERSION=v1.35.0
            curl -L https://github.com/operator-framework/operator-registry/releases/download/${OPM_VERSION}/linux-amd64-opm -o /tmp/opm
            chmod +x /tmp/opm
            export PATH=/tmp:$PATH
          fi
          
          # CRITICAL: First verify the catalog image directly (most reliable method)
          echo "Step 1: Verifying catalog image contains operator..."
          OPERATOR_FOUND=false
          
          # Try to render the catalog image directly - this is the most reliable check
          echo "Rendering catalog image: ${{ env.CATALOG_IMAGE }}"
          CATALOG_RENDER_OUTPUT=$(opm render ${{ env.CATALOG_IMAGE }} 2>&1 || echo "")
          
          if echo "$CATALOG_RENDER_OUTPUT" | grep -q "toolhive-operator"; then
            echo "✓ Operator 'toolhive-operator' found in catalog image!"
            OPERATOR_FOUND=true
          elif echo "$CATALOG_RENDER_OUTPUT" | grep -q "olm.package\|olm.bundle\|olm.channel"; then
            echo "WARNING: Catalog contains OLM data but 'toolhive-operator' not found"
            echo "Catalog contents:"
            echo "$CATALOG_RENDER_OUTPUT" | head -30
          else
            echo "ERROR: Catalog image does not contain valid OLM data!"
            echo "opm render output:"
            echo "$CATALOG_RENDER_OUTPUT" | head -30
          fi
          
          # Step 2: Also try querying the catalog pod (secondary check)
          if [ "$OPERATOR_FOUND" != "true" ]; then
            echo ""
            echo "Step 2: Attempting to query catalog pod..."
            MAX_ATTEMPTS=3
            ATTEMPT=0
            
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$OPERATOR_FOUND" != "true" ]; do
              ATTEMPT=$((ATTEMPT + 1))
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Querying catalog pod..."
              
              # Try to exec into the pod and use opm there (if opm is available in pod)
              if oc exec -n openshift-marketplace $CATALOG_POD -- opm list 2>/dev/null | grep -q "toolhive-operator"; then
                echo "✓ Operator 'toolhive-operator' found in catalog pod!"
                OPERATOR_FOUND=true
                break
              fi
              
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "Operator not found in pod, waiting 3 seconds before retry..."
                sleep 3
              fi
            done
          fi
          
          # Final check - fail if operator not found
          if [ "$OPERATOR_FOUND" != "true" ]; then
            echo ""
            echo "=========================================="
            echo "ERROR: Operator 'toolhive-operator' NOT found in catalog!"
            echo "=========================================="
            echo ""
            echo "Catalog image: ${{ env.CATALOG_IMAGE }}"
            echo ""
            echo "=== Diagnostic Information ==="
            echo ""
            echo "1. Catalog pod status:"
            oc get pod $CATALOG_POD -n openshift-marketplace -o yaml | grep -A 5 "status:" || true
            echo ""
            echo "2. Catalog pod logs:"
            oc logs -n openshift-marketplace $CATALOG_POD --tail=50 || true
            echo ""
            echo "3. Catalog image render output:"
            opm render ${{ env.CATALOG_IMAGE }} 2>&1 | head -50 || echo "Could not render catalog"
            echo ""
            echo "4. Attempting to list packages from catalog pod:"
            oc exec -n openshift-marketplace $CATALOG_POD -- opm list 2>&1 || echo "Could not list packages (opm may not be in pod)"
            echo ""
            echo "5. CatalogSource status:"
            oc get catalogsource toolhive-test-catalog -n openshift-marketplace -o yaml | grep -A 10 "status:" || true
            echo ""
            echo "=========================================="
            echo "SOLUTION:"
            echo "The catalog image appears to be empty or was built with an incompatible bundle."
            echo ""
            echo "1. Rebuild the catalog using the build-catalog workflow:"
            echo "   - Go to Actions → Build Catalog Image → Run workflow"
            echo "   - Ensure it uses: quay.io/okderators/toolhive-operator-bundle:v0.3.5"
            echo ""
            echo "2. Verify the bundle image is AMD64:"
            echo "   docker inspect quay.io/okderators/toolhive-operator-bundle:v0.3.5 --format '{{.Architecture}}'"
            echo "   Should output: amd64"
            echo ""
            echo "3. After rebuilding, the catalog image will contain the operator"
            echo "=========================================="
            exit 1
          fi
          
          echo "✓ Catalog verification complete - operator 'toolhive-operator' is available in catalog"
      
      - name: Apply Subscription (after CatalogSource is READY)
        run: |
          set -e
          echo "Applying Subscription (CatalogSource is now READY)..."
          
          # Delete existing Subscription if it exists (to recreate it fresh)
          oc delete subscription toolhive-operator -n ${{ env.OPERATOR_NS }} --ignore-not-found=true || true
          sleep 2
          
          # Apply Subscription from split files
          SUBSCRIPTION_APPLIED=false
          for file in temp-manifests/resource-*.yaml; do
            [ ! -f "$file" ] && continue
            if grep -q "kind: Subscription" "$file" 2>/dev/null; then
              oc apply -f "$file"
              echo "Subscription applied from $file"
              SUBSCRIPTION_APPLIED=true
              break
            fi
          done
          
          if [ "$SUBSCRIPTION_APPLIED" = "false" ]; then
            echo "WARNING: Subscription not found in split files, applying from full manifest"
            # Extract Subscription using grep/awk as fallback
            awk '/^---$/{p=0} /kind: Subscription/{p=1} p' temp-manifests/olm-resources.yaml | oc apply -f - || {
              echo "ERROR: Failed to apply Subscription"
              exit 1
            }
          fi
          
          echo "Subscription applied"
          
          # Show Subscription status
          sleep 3
          echo "=== Subscription status ==="
          oc get subscription toolhive-operator -n ${{ env.OPERATOR_NS }} -o yaml || true
      
      - name: Wait for operator installation (OKD OLM)
        run: |
          set -e
          echo "Waiting for InstallPlan (OKD OLM)..."
          
          # First, wait for InstallPlan to be created
          echo "Waiting for InstallPlan to be created..."
          MAX_WAIT=120
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            INSTALLPLAN_COUNT=$(oc get installplan -n ${{ env.OPERATOR_NS }} -l "operators.coreos.com/toolhive-operator.${{ env.OPERATOR_NS }}" --no-headers 2>/dev/null | wc -l || echo "0")
            if [ "$INSTALLPLAN_COUNT" -gt 0 ]; then
              echo "InstallPlan found"
              break
            fi
            echo "Waiting for InstallPlan to be created... (${ELAPSED}s/${MAX_WAIT}s)"
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          
          if [ "$INSTALLPLAN_COUNT" -eq 0 ]; then
            echo "ERROR: InstallPlan was not created"
            echo "=== Subscription status ==="
            oc get subscription toolhive-operator -n ${{ env.OPERATOR_NS }} -o yaml
            echo "=== Subscription conditions ==="
            oc get subscription toolhive-operator -n ${{ env.OPERATOR_NS }} -o jsonpath='{.status.conditions[*]}' || true
            echo ""
            echo "=== CatalogSource status ==="
            oc get catalogsource toolhive-test-catalog -n openshift-marketplace -o yaml
            echo "=== Available operators in catalog ==="
            # Try to see what operators are available
            CATALOG_POD=$(oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
            if [ -n "$CATALOG_POD" ]; then
              echo "Catalog pod: $CATALOG_POD"
              oc exec -n openshift-marketplace $CATALOG_POD -- ls -la /configs 2>/dev/null || true
            fi
            exit 1
          fi
          
          # Now wait for InstallPlan to complete
          if ! timeout 300 bash -c 'until oc get installplan -n ${{ env.OPERATOR_NS }} -l "operators.coreos.com/toolhive-operator.${{ env.OPERATOR_NS }}" 2>/dev/null | grep -q Complete; do sleep 5; done'; then
            echo "ERROR: InstallPlan did not complete"
            echo "=== InstallPlan status ==="
            oc get installplan -n ${{ env.OPERATOR_NS }} -o yaml
            echo "=== InstallPlan describe ==="
            oc describe installplan -n ${{ env.OPERATOR_NS }} -l "operators.coreos.com/toolhive-operator.${{ env.OPERATOR_NS }}" || true
            echo "=== Subscription status ==="
            oc get subscription -n ${{ env.OPERATOR_NS }} -o yaml
            echo "=== Subscription conditions ==="
            oc get subscription toolhive-operator -n ${{ env.OPERATOR_NS }} -o jsonpath='{.status.conditions[*]}' || true
            echo ""
            exit 1
          fi
          echo "InstallPlan completed"
          
          echo "Waiting for CSV to be Succeeded (OKD OLM)..."
          if ! oc wait --for=jsonpath='{.status.phase}'=Succeeded \
            csv -n ${{ env.OPERATOR_NS }} \
            -l "operators.coreos.com/toolhive-operator.${{ env.OPERATOR_NS }}" \
            --timeout=${{ env.TEST_TIMEOUT }}; then
            echo "ERROR: CSV did not reach Succeeded phase"
            echo "CSV status:"
            oc get csv -n ${{ env.OPERATOR_NS }} -o yaml
            echo "CSV conditions:"
            oc get csv -n ${{ env.OPERATOR_NS }} -o jsonpath='{.items[*].status.conditions}' || true
            exit 1
          fi
          echo "CSV is Succeeded"
          
          echo "Waiting for operator deployment..."
          if ! oc wait --for=condition=available \
            deployment/toolhive-operator -n ${{ env.OPERATOR_NS }} \
            --timeout=${{ env.TEST_TIMEOUT }}; then
            echo "ERROR: Operator deployment did not become available"
            echo "Deployment status:"
            oc get deployment toolhive-operator -n ${{ env.OPERATOR_NS }} -o yaml
            echo "Deployment pods:"
            oc get pods -n ${{ env.OPERATOR_NS }} -l name=toolhive-operator
            echo "Pod logs:"
            oc logs -n ${{ env.OPERATOR_NS }} -l name=toolhive-operator --tail=50 || true
            exit 1
          fi
          echo "Operator deployment is available"
      
      # Phase 6: Declarative Validation and Testing (Chainsaw)
      - name: Run Chainsaw tests
        run: |
          set -e
          export KUBECONFIG=${HOME}/.kube/config
          echo "Running Chainsaw tests in namespace: ${{ env.OPERATOR_NS }}"
          if ! chainsaw test --test-dir ./test-suites --namespace ${{ env.OPERATOR_NS }}; then
            echo "ERROR: Chainsaw tests failed"
            echo "Collecting diagnostic information (OKD-compatible)..."
            oc get all -n ${{ env.OPERATOR_NS }}
            oc get mcpserver -n ${{ env.OPERATOR_NS }} || true
            exit 1
          fi
          echo "All Chainsaw tests passed"
      
      # Phase 7: Cleanup
      - name: Collect diagnostics on failure
        if: failure()
        run: |
          echo "=== Collecting diagnostic information (OKD-compatible) ==="
          echo "--- Cluster state ---"
          oc get all -A | grep -E "(toolhive|olm)" || true
          echo "--- OLM resources (OKD standard) ---"
          oc get catalogsource,subscription,operatorgroup,csv -A || true
          echo "--- Operator logs ---"
          oc logs -n ${{ env.OPERATOR_NS }} -l name=toolhive-operator --tail=100 || true
          echo "--- Events ---"
          oc get events -n ${{ env.OPERATOR_NS }} --sort-by='.lastTimestamp' | tail -20 || true
          echo "=== End diagnostics ==="
      
      - name: Cleanup OLM resources (OKD-compatible)
        if: always()
        run: |
          set +e
          echo "Cleaning up OLM resources (OKD-compatible)..."
          oc delete subscription toolhive-operator -n ${{ env.OPERATOR_NS }} --ignore-not-found=true || true
          oc delete operatorgroup toolhive-operator-group -n ${{ env.OPERATOR_NS }} --ignore-not-found=true || true
          oc delete catalogsource toolhive-test-catalog -n openshift-marketplace --ignore-not-found=true || true
          oc delete namespace ${{ env.OPERATOR_NS }} --ignore-not-found=true || true
          echo "Cleanup completed"
      
      - name: Delete KIND cluster
        if: always()
        run: |
          set +e
          kind delete cluster --name ${{ env.CLUSTER_NAME }} || true
          echo "KIND cluster deleted"

