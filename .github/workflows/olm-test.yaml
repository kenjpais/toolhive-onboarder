name: OLM Test (OKD Compatible)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      catalog_image:
        description: 'Catalog image to use'
        required: false
        default: 'quay.io/kpais/toolhive-test-catalog:latest'

env:
  OPERATOR_NS: toolhive-test-ns
  CATALOG_IMAGE: ${{ github.event.inputs.catalog_image || 'quay.io/kpais/toolhive-test-catalog:latest' }}
  TEST_TIMEOUT: 10m
  CLUSTER_NAME: toolhive-olm-test

jobs:
  olm-test:
    name: OLM Operator Test (OKD Compatible)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}
    
    steps:
      # Phase 2: CI Environment Setup
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'
      
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Install Chainsaw
        uses: kyverno/action-install-chainsaw@v0.2.13
        with:
          release: v0.2.12
      
      - name: Install OpenShift CLI (oc) for OKD compatibility
        run: |
          set -e
          echo "Installing OpenShift CLI (oc) for OKD compatibility..."
          # Install OpenShift CLI compatible with OKD
          # Try multiple version paths for reliability
          OC_VERSION=4.15
          if ! curl -Lf https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable-${OC_VERSION}/openshift-client-linux.tar.gz -o /tmp/oc.tar.gz 2>/dev/null; then
            if ! curl -Lf https://mirror.openshift.com/pub/openshift-v4/clients/ocp/${OC_VERSION}/openshift-client-linux.tar.gz -o /tmp/oc.tar.gz 2>/dev/null; then
              # Fallback to latest stable
              curl -Lf https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz -o /tmp/oc.tar.gz
            fi
          fi
          tar -xz -C /usr/local/bin -f /tmp/oc.tar.gz
          chmod +x /usr/local/bin/oc
          oc version --client
          echo "OpenShift CLI (oc) installed for OKD compatibility"
      
      - name: Verify kubectl and oc
        run: |
          set -e
          kubectl version --client
          oc version --client
          echo "kubectl and oc are available"
      
      # Phase 3: Cluster Provisioning and OLM Installation
      # Note: Using KIND with OLM installation to simulate OKD environment
      # KIND does not support full OKD distribution, but we simulate OKD by:
      # - Installing OLM (which OKD includes by default)
      # - Using OpenShift CLI (oc) for OKD-compatible operations
      # - Using OKD standard namespaces (openshift-marketplace)
      # In a real OKD cluster, OLM is pre-installed
      - name: Create KIND Cluster
        uses: helm/kind-action@v1.12.0
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          version: v0.29.0
          node_image: kindest/node:v1.32.8
      
      - name: Configure kubectl and oc for KIND
        run: |
          set -e
          kind get kubeconfig --name ${{ env.CLUSTER_NAME }} > ${HOME}/.kube/config
          # Wait for cluster to be ready
          kubectl wait --for=condition=Ready node --all --timeout=120s
          kubectl cluster-info
          oc cluster-info || echo "Note: oc cluster-info may not work with KIND, but oc is available for OKD-compatible operations"
          echo "KIND cluster is ready (using OKD-compatible tooling)"
      
      - name: Install OLM CRDs (OKD includes OLM by default, but installing for KIND)
        run: |
          set -e
          echo "Installing OLM CRDs (simulating OKD environment where OLM is pre-installed)..."
          # Download CRDs file first
          curl -L https://github.com/operator-framework/operator-lifecycle-manager/releases/download/v0.28.0/crds.yaml -o /tmp/olm-crds.yaml
          # Use server-side apply to handle large CRDs with large annotations
          # This bypasses the client-side annotation size limit
          kubectl apply --server-side -f /tmp/olm-crds.yaml || kubectl apply --server-side --force-conflicts -f /tmp/olm-crds.yaml
          echo "OLM CRDs installed successfully"
      
      - name: Install OLM (OKD includes OLM by default, but installing for KIND)
        run: |
          set -e
          echo "Installing OLM components (simulating OKD environment where OLM is pre-installed)..."
          kubectl apply -f https://github.com/operator-framework/operator-lifecycle-manager/releases/download/v0.28.0/olm.yaml
          echo "OLM components installed"
      
      - name: Wait for OLM to be ready (OKD includes OLM by default)
        run: |
          set -e
          echo "Waiting for OLM operator deployment (OKD includes OLM by default)..."
          if ! oc wait --for=condition=available --timeout=5m deployment/olm-operator -n olm; then
            echo "ERROR: OLM operator deployment failed"
            oc get pods -n olm
            oc describe deployment/olm-operator -n olm
            exit 1
          fi
          
          echo "Waiting for catalog operator deployment..."
          if ! oc wait --for=condition=available --timeout=5m deployment/catalog-operator -n olm; then
            echo "ERROR: Catalog operator deployment failed"
            oc get pods -n olm
            oc describe deployment/catalog-operator -n olm
            exit 1
          fi
          
          echo "Waiting for packageserver deployment..."
          if ! oc wait --for=condition=available --timeout=5m deployment/packageserver -n olm; then
            echo "ERROR: Packageserver deployment failed"
            oc get pods -n olm
            oc describe deployment/packageserver -n olm
            exit 1
          fi
          
          echo "OLM is ready (OKD-compatible)"
      
      - name: Create openshift-marketplace namespace (OKD standard namespace)
        run: |
          set -e
          oc create namespace openshift-marketplace --dry-run=client -o yaml | oc apply -f -
          echo "openshift-marketplace namespace created (OKD standard namespace for CatalogSources)"
      
      # Phase 4: Catalog Image Preparation
      - name: Prepare catalog image
        run: |
          set -e
          echo "=========================================="
          echo "Catalog Image Verification"
          echo "=========================================="
          echo "Using catalog image: ${{ env.CATALOG_IMAGE }}"
          echo ""
          echo "NOTE: This step will verify the catalog image contains the 'toolhive-operator'."
          echo "If verification fails, you must rebuild the catalog using the build-catalog workflow."
          echo ""
          
          # Verify image exists and check architecture
          echo "Step 1: Verifying catalog image exists and architecture..."
          if ! docker pull ${{ env.CATALOG_IMAGE }}; then
            echo "ERROR: Failed to pull catalog image: ${{ env.CATALOG_IMAGE }}"
            echo "Please ensure the image exists and is accessible"
            exit 1
          fi
          
          # Check image architecture
          ARCH=$(docker inspect ${{ env.CATALOG_IMAGE }} --format '{{.Architecture}}' || echo "unknown")
          echo "Catalog image architecture: $ARCH"
          
          # Verify it's amd64/x86_64 (required for CI environment)
          if [ "$ARCH" != "amd64" ] && [ "$ARCH" != "x86_64" ]; then
            echo "ERROR: Catalog image architecture is $ARCH, but CI environment requires amd64/x86_64"
            echo "Please rebuild the catalog image for linux/amd64 architecture"
            echo "You can use the build-catalog workflow to rebuild it"
            exit 1
          fi
          
          echo "Catalog image verified (architecture: $ARCH)"
          
          # CRITICAL: Verify catalog contains operator before deploying
          echo "Verifying catalog image contains 'toolhive-operator'..."
          
          # Install opm CLI if not available
          if ! command -v opm &> /dev/null; then
            echo "Installing opm CLI for catalog verification..."
            OPM_VERSION=v1.35.0
            curl -L https://github.com/operator-framework/operator-registry/releases/download/${OPM_VERSION}/linux-amd64-opm -o /tmp/opm
            chmod +x /tmp/opm
            export PATH=/tmp:$PATH
          fi
          
          # CRITICAL: Verify catalog can be rendered and contains the operator
          echo "Rendering catalog image to verify contents..."
          echo "Catalog image: ${{ env.CATALOG_IMAGE }}"
          
          # Capture render output for analysis
          RENDER_OUTPUT=$(opm render ${{ env.CATALOG_IMAGE }} 2>&1 || echo "RENDER_FAILED")
          
          # Check if render failed
          if echo "$RENDER_OUTPUT" | grep -q "RENDER_FAILED\|error\|Error\|ERROR"; then
            echo "ERROR: Failed to render catalog image!"
            echo "opm render output:"
            echo "$RENDER_OUTPUT"
            echo ""
            echo "The catalog image may be corrupted or inaccessible."
            echo "Please rebuild the catalog using the build-catalog workflow."
            exit 1
          fi
          
          # Debug: Show what we got from opm render
          echo "opm render output length: $(echo "$RENDER_OUTPUT" | wc -l) lines"
          echo "First 20 lines of render output:"
          echo "$RENDER_OUTPUT" | head -20
          echo ""
          
          # Check if catalog contains toolhive-operator (exact match required)
          # Look for package name in various JSON formats
          if echo "$RENDER_OUTPUT" | grep -qE '"package"\s*:\s*"toolhive-operator"|"packageName"\s*:\s*"toolhive-operator"|"name"\s*:\s*"toolhive-operator"'; then
            echo "✓ Catalog image contains 'toolhive-operator' package (exact match)"
            echo "Sample catalog content:"
            echo "$RENDER_OUTPUT" | grep -i "toolhive-operator\|package" | head -5
          elif echo "$RENDER_OUTPUT" | grep -qi "toolhive-operator"; then
            echo "✓ Catalog image contains 'toolhive-operator' (found in content)"
            echo "Sample catalog content:"
            echo "$RENDER_OUTPUT" | grep -i "toolhive-operator" | head -5
          elif echo "$RENDER_OUTPUT" | grep -q "olm.package\|olm.bundle\|olm.channel"; then
            echo ""
            echo "=========================================="
            echo "ERROR: Catalog contains OLM data but 'toolhive-operator' NOT found!"
            echo "=========================================="
            echo "Catalog image: ${{ env.CATALOG_IMAGE }}"
            echo ""
            echo "The catalog contains OLM metadata but does not include the 'toolhive-operator' package."
            echo "This indicates the catalog was built with a different bundle or is empty."
            echo ""
            echo "Catalog contents (first 30 lines):"
            echo "$RENDER_OUTPUT" | head -30
            echo ""
            echo "All packages found in catalog:"
            echo "$RENDER_OUTPUT" | grep -i "\"package\"" | head -10 || echo "No packages found"
            echo ""
            echo "=========================================="
            echo "SOLUTION:"
            echo "Rebuild the catalog using the build-catalog workflow:"
            echo "  1. Go to Actions → Build Catalog Image → Run workflow"
            echo "  2. Ensure it uses: operator_bundle_image: quay.io/okderators/toolhive-operator-bundle:v0.3.5"
            echo "  3. Wait for the build to complete"
            echo "  4. Re-run this test workflow"
            echo "=========================================="
            exit 1
          else
            echo ""
            echo "=========================================="
            echo "ERROR: Catalog image does not contain valid OLM catalog data!"
            echo "=========================================="
            echo "Catalog image: ${{ env.CATALOG_IMAGE }}"
            echo ""
            echo "The catalog image appears to be empty or corrupted."
            echo ""
            echo "opm render output (first 50 lines):"
            echo "$RENDER_OUTPUT" | head -50
            echo ""
            echo "=========================================="
            echo "SOLUTION:"
            echo "Rebuild the catalog using the build-catalog workflow:"
            echo "  1. Go to Actions → Build Catalog Image → Run workflow"
            echo "  2. Ensure it uses: operator_bundle_image: quay.io/okderators/toolhive-operator-bundle:v0.3.5"
            echo "  3. Wait for the build to complete"
            echo "  4. Re-run this test workflow"
            echo "=========================================="
            exit 1
          fi
          
          echo "Catalog image verified - contains operator and correct architecture"
          echo "Note: Catalog image will be pulled by the cluster when CatalogSource is created"
          echo "If using a local image, it would need to be loaded into KIND:"
          echo "  kind load docker-image ${{ env.CATALOG_IMAGE }} --name ${{ env.CLUSTER_NAME }}"
          echo "Catalog image prepared"
      
      # Phase 5: Declarative OLM Deployment (Helm)
      - name: Create temp-manifests directory
        run: |
          set -e
          mkdir -p temp-manifests
          echo "temp-manifests directory created"
      
      - name: Render Helm chart
        run: |
          set -e
          echo "Rendering Helm chart..."
          # Note: OperatorGroup is cluster-scoped (empty targetNamespaces) because
          # the operator installs CRDs which are cluster-scoped resources
          # The values.yaml already has targetNamespaces: [] as default, so we don't need to override it
          if ! helm template toolhive-olm ./toolhive-olm-chart \
            --set catalogSource.image=${{ env.CATALOG_IMAGE }} \
            --set namespace.name=${{ env.OPERATOR_NS }} \
            --set subscription.channel=stable \
            --set subscription.source=toolhive-test-catalog \
            --set subscription.sourceNamespace=openshift-marketplace \
            > temp-manifests/olm-resources.yaml; then
            echo "ERROR: Failed to render Helm chart"
            exit 1
          fi
          
          echo "Helm chart rendered successfully"
          echo ""
          echo "=== Verifying OperatorGroup is cluster-scoped ==="
          
          # Verify OperatorGroup has targetNamespaces: [] (cluster-scoped)
          if grep -A 15 "kind: OperatorGroup" temp-manifests/olm-resources.yaml | grep -q "targetNamespaces: \[\]"; then
            echo "✓ OperatorGroup is cluster-scoped (targetNamespaces: [])"
            echo "OperatorGroup spec:"
            grep -A 15 "kind: OperatorGroup" temp-manifests/olm-resources.yaml | grep -A 10 "spec:"
          elif grep -A 15 "kind: OperatorGroup" temp-manifests/olm-resources.yaml | grep -q "targetNamespaces:"; then
            echo "✗ ERROR: OperatorGroup has targetNamespaces set (not cluster-scoped)!"
            echo "This will cause the subscription to fail for cluster-scoped operators."
            echo "OperatorGroup spec:"
            grep -A 15 "kind: OperatorGroup" temp-manifests/olm-resources.yaml | grep -A 10 "spec:"
            exit 1
          else
            echo "⚠ WARNING: Could not verify targetNamespaces in OperatorGroup"
            echo "Full OperatorGroup:"
            grep -A 20 "kind: OperatorGroup" temp-manifests/olm-resources.yaml
          fi
          
          echo ""
          echo "--- Rendered manifests (first 100 lines) ---"
          head -100 temp-manifests/olm-resources.yaml
      
      - name: Split and apply resources in order
        run: |
          set -e
          echo "Splitting resources to apply in correct order..."
          
          # Clean up any existing split files
          rm -f temp-manifests/resource-*.yaml
          
          # Split YAML by document separator using awk (more reliable than csplit)
          # Handle both cases: file starting with --- or not
          awk '
            BEGIN { file=0; content="" }
            /^---$/ {
              if (content != "") {
                print content > "temp-manifests/resource-"file".yaml"
                file++
                content=""
              }
              next
            }
            { content = content $0 "\n" }
            END {
              if (content != "") {
                print content > "temp-manifests/resource-"file".yaml"
              }
            }
          ' temp-manifests/olm-resources.yaml
          
          # Remove empty files
          find temp-manifests -name "resource-*.yaml" -size 0 -delete
          
          echo "Split into $(ls -1 temp-manifests/resource-*.yaml 2>/dev/null | wc -l) resource files"
          
          # Apply CatalogSource first
          echo "Applying CatalogSource first..."
          CATALOG_APPLIED=false
          for file in temp-manifests/resource-*.yaml; do
            [ ! -f "$file" ] && continue
            if grep -q "kind: CatalogSource" "$file" 2>/dev/null; then
              oc apply -f "$file"
              echo "CatalogSource applied from $file"
              CATALOG_APPLIED=true
              break
            fi
          done
          
          if [ "$CATALOG_APPLIED" = "false" ]; then
            echo "WARNING: CatalogSource not found in split files, applying all resources"
            oc apply -f temp-manifests/olm-resources.yaml
          else
            # Apply Namespace and OperatorGroup (but not Subscription yet)
            echo "Applying Namespace and OperatorGroup..."
            for file in temp-manifests/resource-*.yaml; do
              [ ! -f "$file" ] && continue
              if grep -q "kind: Namespace\|kind: OperatorGroup" "$file" 2>/dev/null; then
                oc apply -f "$file" || true
              fi
            done
          fi
          
          echo "Initial resources applied (CatalogSource, Namespace, OperatorGroup)"
          
          # CRITICAL: Verify OperatorGroup was applied correctly as cluster-scoped
          echo ""
          echo "=== Verifying OperatorGroup is cluster-scoped after apply ==="
          sleep 2  # Give Kubernetes a moment to process
          TARGET_NS=$(oc get operatorgroup toolhive-operator-group -n ${{ env.OPERATOR_NS }} -o jsonpath='{.spec.targetNamespaces[*]}' 2>/dev/null || echo "not found")
          if [ -z "$TARGET_NS" ] || [ "$TARGET_NS" = "" ]; then
            echo "✓ OperatorGroup is cluster-scoped (targetNamespaces: [] or empty)"
            oc get operatorgroup toolhive-operator-group -n ${{ env.OPERATOR_NS }} -o yaml | grep -A 5 "spec:"
          else
            echo "✗ ERROR: OperatorGroup is NOT cluster-scoped!"
            echo "targetNamespaces: [$TARGET_NS]"
            echo "Full OperatorGroup:"
            oc get operatorgroup toolhive-operator-group -n ${{ env.OPERATOR_NS }} -o yaml
            echo ""
            echo "This will cause the subscription to fail. The OperatorGroup must have targetNamespaces: [] for cluster-scoped operators."
            exit 1
          fi
      
      - name: Wait for CatalogSource to be READY (OKD standard)
        run: |
          set -e
          echo "Waiting for CatalogSource to be READY (OKD openshift-marketplace namespace)..."
          echo "First, checking if catalog-operator is ready..."
          oc wait --for=condition=available --timeout=2m deployment/catalog-operator -n olm || echo "Warning: catalog-operator might not be fully ready"
          
          echo "Checking CatalogSource status..."
          oc get catalogsource toolhive-test-catalog -n openshift-marketplace -o yaml || echo "CatalogSource not found yet"
          
          echo "Waiting for CatalogSource pod to be created..."
          timeout 120 bash -c 'until oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog 2>/dev/null | grep -q toolhive-test-catalog; do echo "Waiting for catalog pod..."; sleep 5; done' || echo "Catalog pod not created yet"
          
          echo "Checking catalog pod status..."
          oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog || true
          
          # Monitor pod status and fail fast on CrashLoopBackOff
          echo "Monitoring catalog pod status (will fail fast on CrashLoopBackOff)..."
          MAX_WAIT=60  # Wait up to 60 seconds for pod to stabilize
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
          POD_STATUS=$(oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "Unknown")
            RESTART_COUNT=$(oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog -o jsonpath='{.items[0].status.containerStatuses[0].restartCount}' 2>/dev/null || echo "0")
            
          if [ "$POD_STATUS" = "CrashLoopBackOff" ] || [ "$POD_STATUS" = "Error" ]; then
              echo "ERROR: Catalog pod is in $POD_STATUS state (restart count: $RESTART_COUNT)"
              echo "Failing fast to avoid waiting for timeout..."
              
            echo "=== Catalog pod describe ==="
            oc describe pod -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog || true
              
            echo "=== CatalogSource pod logs (all containers) ==="
            oc logs -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog --all-containers=true --tail=100 || true
              
            echo "=== Previous container logs (if any) ==="
            oc logs -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog --previous --tail=100 || true
              
              # Check for architecture mismatch error
              LOGS=$(oc logs -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog --previous --tail=50 2>/dev/null || echo "")
              if echo "$LOGS" | grep -q "exec format error"; then
                echo ""
                echo "=========================================="
                echo "ARCHITECTURE MISMATCH DETECTED!"
                echo "The catalog image appears to be built for the wrong architecture."
                echo "Error: exec format error (typically means ARM image on AMD64 or vice versa)"
                echo ""
                echo "Solution: Rebuild the catalog image for linux/amd64 architecture"
                echo "Use the build-catalog workflow to rebuild:"
                echo "  .github/workflows/build-catalog.yaml"
                echo "=========================================="
              fi
              
            echo "=== Events in openshift-marketplace ==="
            oc get events -n openshift-marketplace --sort-by='.lastTimestamp' | tail -30 || true
              
              exit 1
            fi
            
            # If pod is running or pending, continue waiting
            if [ "$POD_STATUS" = "Running" ] || [ "$POD_STATUS" = "Pending" ] || [ "$POD_STATUS" = "ContainerCreating" ]; then
              echo "Pod status: $POD_STATUS (restart count: $RESTART_COUNT), continuing to wait..."
              sleep 5
              ELAPSED=$((ELAPSED + 5))
            else
              break
          fi
          done
          
          echo "Waiting for CatalogSource to become READY..."
          if ! oc wait --for=jsonpath='{.status.connectionState.lastObservedState}'=READY \
            catalogsource/toolhive-test-catalog -n openshift-marketplace \
            --timeout=${{ env.TEST_TIMEOUT }}; then
            echo "ERROR: CatalogSource did not become READY"
            echo "=== CatalogSource status ==="
            oc get catalogsource toolhive-test-catalog -n openshift-marketplace -o yaml
            echo "=== CatalogSource pods ==="
            oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog
            echo "=== Catalog pod describe ==="
            oc describe pod -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog || true
            echo "=== CatalogSource pod logs (all containers) ==="
            oc logs -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog --all-containers=true --tail=100 || true
            echo "=== Previous container logs (if any) ==="
            oc logs -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog --previous --tail=100 || true
            echo "=== Catalog-operator logs ==="
            oc logs -n olm -l app=catalog-operator --tail=50 || true
            echo "=== Events in openshift-marketplace ==="
            oc get events -n openshift-marketplace --sort-by='.lastTimestamp' | tail -30 || true
            exit 1
          fi
          echo "CatalogSource is READY (OKD-compatible)"
      
      - name: Verify CoreDNS is running (required for CatalogSource DNS)
        run: |
          set -e
          echo "=== Verifying CoreDNS/kube-dns is running ==="
          
          # Check for CoreDNS pods
          DNS_PODS=$(oc get pods -n kube-system -l k8s-app=kube-dns 2>/dev/null | grep -v NAME | wc -l || echo "0")
          if [ "$DNS_PODS" -eq 0 ]; then
            # Try alternative label
            DNS_PODS=$(oc get pods -n kube-system -l k8s-app=coredns 2>/dev/null | grep -v NAME | wc -l || echo "0")
          fi
          
          if [ "$DNS_PODS" -gt 0 ]; then
            echo "✓ Found $DNS_PODS DNS pod(s)"
            oc get pods -n kube-system -l k8s-app=kube-dns 2>/dev/null || oc get pods -n kube-system -l k8s-app=coredns 2>/dev/null || true
            
            # Check if DNS pods are ready
            DNS_READY=$(oc get pods -n kube-system -l k8s-app=kube-dns -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}' 2>/dev/null | grep -c "True" || echo "0")
            if [ "$DNS_READY" -eq 0 ]; then
              DNS_READY=$(oc get pods -n kube-system -l k8s-app=coredns -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}' 2>/dev/null | grep -c "True" || echo "0")
            fi
            
            if [ "$DNS_READY" -gt 0 ]; then
              echo "✓ DNS pods are Ready"
            else
              echo "⚠ WARNING: DNS pods exist but are not Ready"
              echo "This may cause CatalogSource Service DNS resolution to fail"
            fi
          else
            echo "⚠ WARNING: No DNS pods found in kube-system namespace"
            echo "This will prevent CatalogSource Service DNS resolution"
            echo "Listing all pods in kube-system:"
            oc get pods -n kube-system | head -10 || true
          fi
      
      - name: Verify CatalogSource Service DNS resolution (from within cluster)
        run: |
          set -e
          echo "=== Verifying CatalogSource Service DNS resolution ==="
          
          # Check if Service exists
          if ! oc get svc toolhive-test-catalog -n openshift-marketplace &>/dev/null; then
            echo "✗ ERROR: CatalogSource Service does not exist!"
            echo "This is a critical issue - the Service must exist for DNS resolution"
            exit 1
          fi
          
          echo "✓ CatalogSource Service exists"
          oc get svc toolhive-test-catalog -n openshift-marketplace
          
          # Test DNS resolution from within the cluster
          echo ""
          echo "Testing DNS resolution from within cluster..."
          
          # Create a test pod to check DNS
          TEST_POD_NAME="dns-test-$(date +%s)"
          oc run $TEST_POD_NAME --image=busybox:1.36 --restart=Never --rm -i --namespace=openshift-marketplace \
            --command -- nslookup toolhive-test-catalog.openshift-marketplace.svc 2>&1 || {
            echo "⚠ DNS test pod failed (this may be expected)"
          }
          
          # Also try to get the service IP
          SERVICE_IP=$(oc get svc toolhive-test-catalog -n openshift-marketplace -o jsonpath='{.spec.clusterIP}' 2>/dev/null || echo "")
          if [ -n "$SERVICE_IP" ] && [ "$SERVICE_IP" != "<none>" ]; then
            echo "✓ Service has ClusterIP: $SERVICE_IP"
          else
            echo "✗ ERROR: Service does not have a ClusterIP!"
            echo "This will prevent DNS resolution and catalog-operator discovery"
            exit 1
          fi
          
          # DNS verification complete - catalog-operator discovery is handled in the next step
      
      - name: Verify operator exists in catalog
        run: |
          set -e
          echo "Verifying operator 'toolhive-operator' exists in catalog..."
          
          # Wait a bit for catalog to fully index after becoming READY
          echo "Waiting for catalog to fully index (15 seconds)..."
          sleep 15
          
          # Get catalog pod
          CATALOG_POD=$(oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -z "$CATALOG_POD" ]; then
            echo "ERROR: Catalog pod not found"
            exit 1
          fi
          
          echo "Catalog pod: $CATALOG_POD"
          echo "Checking catalog pod is running..."
          oc wait --for=condition=Ready pod/$CATALOG_POD -n openshift-marketplace --timeout=60s || {
            echo "ERROR: Catalog pod not ready"
            exit 1
          }
          
          # Check if catalog database exists (indicates indexing)
          echo "Verifying catalog database exists..."
          DB_FOUND=false
          if oc exec -n openshift-marketplace $CATALOG_POD -- test -f /configs/index.db 2>/dev/null; then
            echo "✓ Catalog database found at /configs/index.db"
            DB_FOUND=true
          elif oc exec -n openshift-marketplace $CATALOG_POD -- test -f /database/index.db 2>/dev/null; then
            echo "✓ Catalog database found at /database/index.db"
            DB_FOUND=true
          else
            echo "ERROR: Catalog database not found!"
            echo "Checking what files exist in the catalog pod:"
            oc exec -n openshift-marketplace $CATALOG_POD -- find / -name "*.db" -type f 2>/dev/null | head -10 || true
            echo "Listing /configs and /database directories:"
            oc exec -n openshift-marketplace $CATALOG_POD -- ls -la /configs /database 2>/dev/null || true
            exit 1
          fi
          
          # CRITICAL: Verify operator package exists in catalog using opm
          echo "Verifying operator package 'toolhive-operator' exists in catalog..."
          
          # Install opm CLI if not available
          if ! command -v opm &> /dev/null; then
            echo "Installing opm CLI for catalog verification..."
            OPM_VERSION=v1.35.0
            curl -L https://github.com/operator-framework/operator-registry/releases/download/${OPM_VERSION}/linux-amd64-opm -o /tmp/opm
            chmod +x /tmp/opm
            export PATH=/tmp:$PATH
          fi
          
          # CRITICAL: First verify the catalog image directly (most reliable method)
          echo "Step 1: Verifying catalog image contains operator..."
          OPERATOR_FOUND=false
          
          # Try to render the catalog image directly - this is the most reliable check
          echo "Rendering catalog image: ${{ env.CATALOG_IMAGE }}"
          CATALOG_RENDER_OUTPUT=$(opm render ${{ env.CATALOG_IMAGE }} 2>&1 || echo "")
          
          if echo "$CATALOG_RENDER_OUTPUT" | grep -q "toolhive-operator"; then
            echo "✓ Operator 'toolhive-operator' found in catalog image!"
            OPERATOR_FOUND=true
          elif echo "$CATALOG_RENDER_OUTPUT" | grep -q "olm.package\|olm.bundle\|olm.channel"; then
            echo "WARNING: Catalog contains OLM data but 'toolhive-operator' not found"
            echo "Catalog contents:"
            echo "$CATALOG_RENDER_OUTPUT" | head -30
          else
            echo "ERROR: Catalog image does not contain valid OLM data!"
            echo "opm render output:"
            echo "$CATALOG_RENDER_OUTPUT" | head -30
          fi
          
          # Step 2: Also try querying the catalog pod (secondary check)
          if [ "$OPERATOR_FOUND" != "true" ]; then
            echo ""
            echo "Step 2: Attempting to query catalog pod..."
            MAX_ATTEMPTS=3
            ATTEMPT=0
            
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$OPERATOR_FOUND" != "true" ]; do
              ATTEMPT=$((ATTEMPT + 1))
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Querying catalog pod..."
              
              # Try to exec into the pod and use opm render (opm list is deprecated/removed)
              # Note: opm may not be available in the catalog pod, so this is a best-effort check
              if oc exec -n openshift-marketplace $CATALOG_POD -- opm render quay.io/kpais/toolhive-test-catalog:latest 2>/dev/null | grep -q "toolhive-operator"; then
                echo "✓ Operator 'toolhive-operator' found in catalog pod!"
                OPERATOR_FOUND=true
                break
              fi
              
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "Operator not found in pod, waiting 3 seconds before retry..."
                sleep 3
              fi
            done
          fi
          
          # Final check - fail if operator not found
          if [ "$OPERATOR_FOUND" != "true" ]; then
            echo ""
            echo "=========================================="
            echo "ERROR: Operator 'toolhive-operator' NOT found in catalog!"
            echo "=========================================="
            echo ""
            echo "Catalog image: ${{ env.CATALOG_IMAGE }}"
            echo ""
            echo "=== Diagnostic Information ==="
            echo ""
            echo "1. Catalog pod status:"
            oc get pod $CATALOG_POD -n openshift-marketplace -o yaml | grep -A 5 "status:" || true
            echo ""
            echo "2. Catalog pod logs:"
            oc logs -n openshift-marketplace $CATALOG_POD --tail=50 || true
            echo ""
            echo "3. Catalog image render output:"
            opm render ${{ env.CATALOG_IMAGE }} 2>&1 | head -50 || echo "Could not render catalog"
            echo ""
            echo "4. Attempting to render catalog from pod:"
            oc exec -n openshift-marketplace $CATALOG_POD -- opm render quay.io/kpais/toolhive-test-catalog:latest 2>&1 | head -30 || echo "Could not render catalog (opm may not be in pod or image not accessible)"
            echo ""
            echo "5. CatalogSource status:"
            oc get catalogsource toolhive-test-catalog -n openshift-marketplace -o yaml | grep -A 10 "status:" || true
            echo ""
            echo "=========================================="
            echo "SOLUTION:"
            echo "The catalog image appears to be empty or was built with an incompatible bundle."
            echo ""
            echo "1. Rebuild the catalog using the build-catalog workflow:"
            echo "   - Go to Actions → Build Catalog Image → Run workflow"
            echo "   - Ensure it uses: quay.io/okderators/toolhive-operator-bundle:v0.3.5"
            echo ""
            echo "2. Verify the bundle image is AMD64:"
            echo "   docker inspect quay.io/okderators/toolhive-operator-bundle:v0.3.5 --format '{{.Architecture}}'"
            echo "   Should output: amd64"
            echo ""
            echo "3. After rebuilding, the catalog image will contain the operator"
            echo "=========================================="
            exit 1
          fi
          
          echo "✓ Catalog verification complete - operator 'toolhive-operator' is available in catalog"
      
      - name: Force catalog-operator to discover CatalogSource (with DNS fix)
        run: |
          set -e
          echo "=== Forcing catalog-operator to discover CatalogSource (ROOT CAUSE FIX) ==="
          
          # CRITICAL: Check if catalog-operator has discovered the CatalogSource
          echo "Step 1: Checking if catalog-operator has discovered CatalogSource..."
          CATALOG_OP_POD=$(oc get pods -n olm -l app=catalog-operator -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          DISCOVERED=false
          
          if [ -n "$CATALOG_OP_POD" ]; then
            # Check last 1000 lines of logs (catalog-operator may have been running for a while)
            # Look for "processing" or mentions of toolhive-test-catalog
            if oc logs -n olm $CATALOG_OP_POD --tail=1000 2>/dev/null | grep -qi "toolhive-test-catalog\|processing.*toolhive" || false; then
              echo "✓ Catalog-operator has discovered toolhive-test-catalog"
              DISCOVERED=true
            else
              echo "✗ Catalog-operator has NOT discovered toolhive-test-catalog"
              echo "ROOT CAUSE: CatalogSource Service DNS is not resolvable, preventing discovery"
              DISCOVERED=false
            fi
          else
            echo "⚠ Could not check catalog-operator logs"
            DISCOVERED=false
          fi
          
          # If not discovered, apply FIX 1: Delete and recreate CatalogSource + Service
          if [ "$DISCOVERED" != "true" ]; then
            echo ""
            echo "Step 2: Applying FIX 1 - Deleting and recreating CatalogSource and Service..."
            
            # Save current CatalogSource spec
            echo "Saving current CatalogSource spec..."
            oc get catalogsource toolhive-test-catalog -n openshift-marketplace -o yaml > /tmp/catalogsource-backup.yaml 2>/dev/null || {
              echo "Could not save CatalogSource, will recreate from Helm template"
            }
            
            # Delete Service first (FIX 4 - forces DNS re-registration)
            echo "Deleting Service to force DNS re-registration..."
            oc delete svc toolhive-test-catalog -n openshift-marketplace --ignore-not-found=true || true
            sleep 3
            
            # Delete CatalogSource (FIX 1 - forces OLM discovery)
            echo "Deleting CatalogSource..."
            oc delete catalogsource toolhive-test-catalog -n openshift-marketplace --ignore-not-found=true || true
            sleep 5
            
            # Recreate CatalogSource (this will also recreate the Service)
            echo "Recreating CatalogSource..."
            if [ -f /tmp/catalogsource-backup.yaml ]; then
              # Remove status and metadata that shouldn't be reapplied
              grep -v "^  status:" /tmp/catalogsource-backup.yaml | \
                grep -v "^  resourceVersion:" | \
                grep -v "^  uid:" | \
                grep -v "^  generation:" | \
                grep -v "^  creationTimestamp:" | \
                oc apply -f - || {
                echo "Failed to recreate from backup, using Helm template..."
                grep -A 20 "kind: CatalogSource" temp-manifests/olm-resources.yaml | oc apply -f - || true
              }
            else
              # Fallback to applying from template
              grep -A 20 "kind: CatalogSource" temp-manifests/olm-resources.yaml | oc apply -f - || true
            fi
            
            echo "Waiting 10 seconds for CatalogSource and Service to be recreated..."
            sleep 10
            
            # Verify Service exists and has ClusterIP
            echo "Verifying Service was recreated..."
            MAX_WAIT=30
            ELAPSED=0
            SERVICE_READY=false
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              SERVICE_IP=$(oc get svc toolhive-test-catalog -n openshift-marketplace -o jsonpath='{.spec.clusterIP}' 2>/dev/null || echo "")
              if [ -n "$SERVICE_IP" ] && [ "$SERVICE_IP" != "<none>" ]; then
                echo "✓ Service recreated with ClusterIP: $SERVICE_IP"
                SERVICE_READY=true
                break
              fi
              echo "Waiting for Service to be recreated... (${ELAPSED}s/${MAX_WAIT}s)"
              sleep 3
              ELAPSED=$((ELAPSED + 3))
            done
            
            if [ "$SERVICE_READY" != "true" ]; then
              echo "✗ ERROR: Service was not recreated properly!"
              exit 1
            fi
            
            # CRITICAL: Verify Service Endpoints are configured (required for connectivity)
            echo ""
            echo "Verifying Service Endpoints are configured..."
            MAX_ENDPOINT_WAIT=30
            ENDPOINT_ELAPSED=0
            ENDPOINTS_READY=false
            while [ $ENDPOINT_ELAPSED -lt $MAX_ENDPOINT_WAIT ]; do
              ENDPOINT_COUNT=$(oc get endpoints toolhive-test-catalog -n openshift-marketplace -o jsonpath='{.subsets[*].addresses[*].ip}' 2>/dev/null | wc -w || echo "0")
              if [ "$ENDPOINT_COUNT" -gt 0 ]; then
                echo "✓ Service Endpoints configured ($ENDPOINT_COUNT endpoint(s))"
                oc get endpoints toolhive-test-catalog -n openshift-marketplace -o yaml | grep -A 10 "subsets:" || true
                ENDPOINTS_READY=true
                break
              fi
              echo "Waiting for Service Endpoints... (${ENDPOINT_ELAPSED}s/${MAX_ENDPOINT_WAIT}s)"
              sleep 3
              ENDPOINT_ELAPSED=$((ENDPOINT_ELAPSED + 3))
            done
            
            if [ "$ENDPOINTS_READY" != "true" ]; then
              echo "✗ ERROR: Service Endpoints are not configured!"
              echo "This will prevent catalog-operator from connecting to the catalog pod"
              echo "Service:"
              oc get svc toolhive-test-catalog -n openshift-marketplace -o yaml || true
              echo "Endpoints:"
              oc get endpoints toolhive-test-catalog -n openshift-marketplace -o yaml || true
              echo "Catalog pod:"
              oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog || true
              exit 1
            fi
            
            # Wait for CatalogSource to be READY
            echo ""
            echo "Waiting for CatalogSource to become READY..."
            MAX_WAIT=60
            ELAPSED=0
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              CATALOG_STATE=$(oc get catalogsource toolhive-test-catalog -n openshift-marketplace -o jsonpath='{.status.connectionState.lastObservedState}' 2>/dev/null || echo "unknown")
              if [ "$CATALOG_STATE" = "READY" ]; then
                echo "✓ CatalogSource is READY"
                break
              fi
              echo "Waiting for CatalogSource to be READY... (${ELAPSED}s/${MAX_WAIT}s) - Current state: $CATALOG_STATE"
              sleep 5
              ELAPSED=$((ELAPSED + 5))
            done
            
            if [ "$CATALOG_STATE" != "READY" ]; then
              echo "⚠ WARNING: CatalogSource state is: $CATALOG_STATE (expected READY)"
              oc get catalogsource toolhive-test-catalog -n openshift-marketplace -o yaml | grep -A 10 "status:" || true
            fi
            
            # CRITICAL: Wait for catalog-operator to complete connection (not just READY state)
            echo ""
            echo "Step 3: Waiting for catalog-operator to complete connection to catalog pod..."
            CHECK_POD_BEFORE_RESTART=$CATALOG_OP_POD
            MAX_CONNECTION_WAIT=90
            CONNECTION_ELAPSED=0
            CONNECTION_COMPLETE=false
            
            while [ $CONNECTION_ELAPSED -lt $MAX_CONNECTION_WAIT ]; do
              if [ -n "$CHECK_POD_BEFORE_RESTART" ]; then
                # Check if connection completed (READY state, not CONNECTING)
                if oc logs -n olm $CHECK_POD_BEFORE_RESTART --tail=1000 2>/dev/null | grep -qi "toolhive-test-catalog.*READY\|toolhive-test-catalog.*state.*READY\|toolhive-test-catalog.*connected" || false; then
                  echo "✓ Catalog-operator has successfully connected to catalog pod!"
                  CONNECTION_COMPLETE=true
                  break
                fi
                
                # Check if still in CONNECTING state
                if oc logs -n olm $CHECK_POD_BEFORE_RESTART --tail=1000 2>/dev/null | grep -qi "toolhive-test-catalog.*CONNECTING" || false; then
                  echo "Catalog-operator is still CONNECTING... (${CONNECTION_ELAPSED}s/${MAX_CONNECTION_WAIT}s)"
                  # Show connection state logs
                  oc logs -n olm $CHECK_POD_BEFORE_RESTART --tail=1000 2>/dev/null | grep -i "toolhive-test-catalog.*state\|toolhive-test-catalog.*CONNECTING" | tail -3 || true
                fi
              fi
              
              sleep 5
              CONNECTION_ELAPSED=$((CONNECTION_ELAPSED + 5))
            done
            
            if [ "$CONNECTION_COMPLETE" != "true" ]; then
              echo "⚠ WARNING: Catalog-operator connection may not have completed"
              echo "This may indicate a network connectivity issue"
              if [ -n "$CHECK_POD_BEFORE_RESTART" ]; then
                echo "Recent connection state logs:"
                oc logs -n olm $CHECK_POD_BEFORE_RESTART --tail=1000 2>/dev/null | grep -i "toolhive-test-catalog.*state\|toolhive-test-catalog.*connect" | tail -10 || true
              fi
            fi
            
            # Apply FIX 2: Restart catalog-operator to flush cache
            echo ""
            echo "Step 4: Applying FIX 2 - Restarting catalog-operator to flush discovery cache..."
            CATALOG_OP_DEPLOY=$(oc get deployment -n olm -l app=catalog-operator -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
            if [ -n "$CATALOG_OP_DEPLOY" ]; then
              echo "Restarting catalog-operator deployment: $CATALOG_OP_DEPLOY"
              oc rollout restart deployment/$CATALOG_OP_DEPLOY -n olm || true
              echo "Waiting 30 seconds for catalog-operator pod to restart and re-discover CatalogSources..."
              sleep 30
              
              # Wait for new pod to be ready
              oc wait --for=condition=Ready pod -n olm -l app=catalog-operator --timeout=60s || true
              
              # Get new pod name
              NEW_CATALOG_OP_POD=$(oc get pods -n olm -l app=catalog-operator -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
              if [ -n "$NEW_CATALOG_OP_POD" ]; then
                echo "New catalog-operator pod: $NEW_CATALOG_OP_POD"
                echo "Waiting 15 seconds for it to process CatalogSources..."
                sleep 15
              fi
            else
              echo "Could not find catalog-operator deployment to restart"
            fi
            
            # CRITICAL: Check if catalog-operator has successfully CONNECTED (not just discovered)
            echo ""
            echo "Step 5: Verifying catalog-operator has successfully CONNECTED to CatalogSource..."
            CHECK_POD=${NEW_CATALOG_OP_POD:-$CATALOG_OP_POD}
            if [ -n "$CHECK_POD" ]; then
              # Wait for connection to complete (not just discovery)
              echo "Waiting for catalog-operator to complete connection to catalog pod..."
              MAX_CONNECTION_WAIT=60
              CONNECTION_ELAPSED=0
              CONNECTED=false
              
              while [ $CONNECTION_ELAPSED -lt $MAX_CONNECTION_WAIT ]; do
                # Check for successful connection (READY state, not CONNECTING)
                if oc logs -n olm $CHECK_POD --tail=500 2>/dev/null | grep -qi "toolhive-test-catalog.*READY\|toolhive-test-catalog.*state.*READY\|toolhive-test-catalog.*connected" || false; then
                  echo "✓ Catalog-operator has successfully connected to toolhive-test-catalog!"
                  CONNECTED=true
                  DISCOVERED=true
                  break
                fi
                
                # Check if still in CONNECTING state
                if oc logs -n olm $CHECK_POD --tail=500 2>/dev/null | grep -qi "toolhive-test-catalog.*CONNECTING" || false; then
                  echo "Catalog-operator is still CONNECTING... (${CONNECTION_ELAPSED}s/${MAX_CONNECTION_WAIT}s)"
                fi
                
                sleep 5
                CONNECTION_ELAPSED=$((CONNECTION_ELAPSED + 5))
              done
              
              if [ "$CONNECTED" != "true" ]; then
                echo "⚠ WARNING: Catalog-operator may not have completed connection"
                echo "Checking catalog-operator logs for connection state..."
                
                # Check for CONNECTING state
                if oc logs -n olm $CHECK_POD --tail=500 2>/dev/null | grep -qi "toolhive-test-catalog.*CONNECTING" || false; then
                  echo "✗ ERROR: Catalog-operator is stuck in CONNECTING state!"
                  echo "This indicates catalog-operator cannot reach the catalog pod's gRPC endpoint"
                  echo ""
                  echo "Recent connection-related logs:"
                  oc logs -n olm $CHECK_POD --tail=500 2>/dev/null | grep -i "toolhive-test-catalog.*state\|toolhive-test-catalog.*connect\|toolhive-test-catalog.*error" | tail -10 || true
                  echo ""
                  echo "SOLUTION: The catalog pod may not be reachable from catalog-operator"
                  echo "This could be due to:"
                  echo "1. DNS not resolving from within the cluster"
                  echo "2. Network policy blocking traffic"
                  echo "3. Catalog pod not responding to gRPC queries"
                  echo ""
                  echo "Attempting to verify catalog pod is reachable..."
                  
                  # Try to verify connectivity from catalog-operator pod
                  CATALOG_POD=$(oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
                  if [ -n "$CATALOG_POD" ]; then
                    echo "Catalog pod: $CATALOG_POD"
                    echo "Testing connectivity from catalog-operator pod..."
                    oc exec -n olm $CHECK_POD -- sh -c "nc -zv toolhive-test-catalog.openshift-marketplace.svc 50051 2>&1 || echo 'Connection test failed'" 2>/dev/null || {
                      echo "⚠ Could not test connectivity (nc may not be available in catalog-operator pod)"
                    }
                  fi
                elif oc logs -n olm $CHECK_POD --tail=200 2>/dev/null | grep -qi "toolhive-test-catalog\|processing.*toolhive" || false; then
                  echo "✓ Found mentions of toolhive-test-catalog in logs (may have connected)"
                  echo "Recent mentions:"
                  oc logs -n olm $CHECK_POD --tail=200 2>/dev/null | grep -i "toolhive-test-catalog\|processing.*toolhive" | tail -5 || true
                  DISCOVERED=true
                else
                  echo "✗ Catalog-operator still hasn't discovered toolhive-test-catalog after fixes"
                  echo "This may indicate a deeper DNS or network issue"
                  echo "Recent catalog-operator logs:"
                  oc logs -n olm $CHECK_POD --tail=50 2>/dev/null | tail -20 || true
                fi
              fi
            fi
          else
            echo ""
            echo "Step 2: Catalog-operator has already discovered the CatalogSource"
            echo "Annotating CatalogSource to trigger refresh..."
            oc annotate catalogsource toolhive-test-catalog -n openshift-marketplace \
              operators.coreos.com/catalog-refresh=$(date +%s) --overwrite || true
            sleep 10
          fi
          
          if [ "$DISCOVERED" != "true" ]; then
            echo ""
            echo "⚠ WARNING: Catalog-operator may still not have discovered the CatalogSource"
            echo "The workflow will continue, but Subscription resolution may fail"
          fi
          
          # Don't fail the step - even if discovery didn't work, we should continue
          # The subscription step will provide better diagnostics
          echo ""
          echo "Discovery step complete. Proceeding to Subscription creation..."
      
      - name: Apply Subscription (after CatalogSource is READY)
        run: |
          set -e
          echo "Applying Subscription (CatalogSource is READY and indexed)..."
          
          # Delete existing Subscription if it exists (to recreate it fresh)
          oc delete subscription toolhive-operator -n ${{ env.OPERATOR_NS }} --ignore-not-found=true || true
          sleep 3
          
          # Apply Subscription from split files
          SUBSCRIPTION_APPLIED=false
          for file in temp-manifests/resource-*.yaml; do
            [ ! -f "$file" ] && continue
            if grep -q "kind: Subscription" "$file" 2>/dev/null; then
              oc apply -f "$file"
              echo "Subscription applied from $file"
              SUBSCRIPTION_APPLIED=true
              break
            fi
          done
          
          if [ "$SUBSCRIPTION_APPLIED" = "false" ]; then
            echo "WARNING: Subscription not found in split files, applying from full manifest"
            # Extract Subscription using grep/awk as fallback
            awk '/^---$/{p=0} /kind: Subscription/{p=1} p' temp-manifests/olm-resources.yaml | oc apply -f - || {
              echo "ERROR: Failed to apply Subscription"
              exit 1
            }
          fi
          
          # CRITICAL: Verify catalog pod is accessible from within cluster before proceeding
          echo ""
          echo "=== Verifying catalog pod is accessible from within cluster ==="
          CATALOG_POD=$(oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$CATALOG_POD" ]; then
            echo "Catalog pod: $CATALOG_POD"
            echo "Checking catalog pod is ready and serving..."
            oc wait --for=condition=Ready pod/$CATALOG_POD -n openshift-marketplace --timeout=30s || {
              echo "⚠ WARNING: Catalog pod not ready"
            }
            
            # Check if we can reach the service from within cluster using a test pod
            echo "Testing catalog service connectivity from within cluster..."
            # Use oc run to create a temporary pod that can query the catalog
            oc run catalog-test-$(date +%s) --image=quay.io/operator-framework/opm:v1.35.0 \
              --restart=Never --rm -i --namespace=openshift-marketplace \
              --command -- sh -c "timeout 10 opm render toolhive-test-catalog.openshift-marketplace.svc:50051 2>&1 | head -20 || echo 'Query failed'" 2>/dev/null || {
              echo "⚠ Could not test catalog connectivity (this is expected if oc run fails)"
            }
          fi
          
          # CRITICAL: Force catalog-operator to re-process by annotating both Subscription and CatalogSource
          echo ""
          echo "Triggering catalog-operator reconciliation..."
          
          # Annotate Subscription to force reconciliation
          echo "Annotating Subscription to trigger reconciliation..."
          oc annotate subscription toolhive-operator -n ${{ env.OPERATOR_NS }} \
            operators.coreos.com/catalog-reconcile=$(date +%s) --overwrite || true
          
          # Annotate CatalogSource to force catalog-operator to refresh its view
          echo "Annotating CatalogSource to trigger refresh..."
          oc annotate catalogsource toolhive-test-catalog -n openshift-marketplace \
            operators.coreos.com/catalog-refresh=$(date +%s) --overwrite || true
          
          # CRITICAL: Delete and recreate Subscription to force fresh resolution
          echo ""
          echo "Deleting and recreating Subscription to force fresh resolution..."
          oc delete subscription toolhive-operator -n ${{ env.OPERATOR_NS }} --ignore-not-found=true || true
          sleep 5
          
          # Reapply Subscription
          SUBSCRIPTION_FILE=$(find temp-manifests -name "resource-*.yaml" -exec grep -l "kind: Subscription" {} \; | head -1)
          if [ -n "$SUBSCRIPTION_FILE" ] && [ -f "$SUBSCRIPTION_FILE" ]; then
            oc apply -f "$SUBSCRIPTION_FILE" || {
              echo "Failed to reapply Subscription, trying from full manifest..."
              awk '/^---$/{p=0} /kind: Subscription/{p=1} p' temp-manifests/olm-resources.yaml | oc apply -f - || true
            }
          else
            awk '/^---$/{p=0} /kind: Subscription/{p=1} p' temp-manifests/olm-resources.yaml | oc apply -f - || true
          fi
          
          # Wait for catalog-operator to process
          echo "Waiting 30 seconds for catalog-operator to process Subscription and CatalogSource..."
          sleep 30
          
          # Show Subscription status
          echo "=== Subscription status ==="
          oc get subscription toolhive-operator -n ${{ env.OPERATOR_NS }} -o yaml || true
          
          # Check catalog-operator logs for processing
          echo ""
          echo "=== Checking catalog-operator processing ==="
          CATALOG_OP_POD=$(oc get pods -n olm -l app=catalog-operator -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$CATALOG_OP_POD" ]; then
            echo "Recent catalog-operator logs (last 100 lines, filtered for toolhive/subscription/resolve/catalog):"
            oc logs -n olm $CATALOG_OP_POD --tail=100 2>/dev/null | grep -i "toolhive\|subscription\|resolve\|catalog\|source" || echo "No relevant logs found"
            echo ""
            echo "Checking for any connection or query errors..."
            oc logs -n olm $CATALOG_OP_POD --tail=200 2>/dev/null | grep -i "error\|fail\|timeout\|connection" | tail -10 || echo "No errors found"
          fi
          
          echo "Subscription applied"
      
      - name: Wait for operator installation (OKD OLM)
        run: |
          set -e
          echo "Waiting for InstallPlan (OKD OLM)..."
          
          # First, wait for InstallPlan to be created
          echo "Waiting for InstallPlan to be created..."
          MAX_WAIT=120
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            INSTALLPLAN_COUNT=$(oc get installplan -n ${{ env.OPERATOR_NS }} -l "operators.coreos.com/toolhive-operator.${{ env.OPERATOR_NS }}" --no-headers 2>/dev/null | wc -l || echo "0")
            if [ "$INSTALLPLAN_COUNT" -gt 0 ]; then
              echo "InstallPlan found"
              break
            fi
            echo "Waiting for InstallPlan to be created... (${ELAPSED}s/${MAX_WAIT}s)"
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          
          if [ "$INSTALLPLAN_COUNT" -eq 0 ]; then
            echo "ERROR: InstallPlan was not created"
            echo ""
            echo "=== CRITICAL: OperatorGroup Status ==="
            echo "Verifying OperatorGroup is cluster-scoped (targetNamespaces: [])..."
            oc get operatorgroup toolhive-operator-group -n ${{ env.OPERATOR_NS }} -o yaml
            echo ""
            echo "=== OperatorGroup spec.targetNamespaces ==="
            TARGET_NS=$(oc get operatorgroup toolhive-operator-group -n ${{ env.OPERATOR_NS }} -o jsonpath='{.spec.targetNamespaces[*]}' 2>/dev/null || echo "not found")
            if [ -z "$TARGET_NS" ] || [ "$TARGET_NS" = "" ]; then
              echo "✓ OperatorGroup is cluster-scoped (targetNamespaces: [] or empty)"
            else
              echo "✗ ERROR: OperatorGroup is NOT cluster-scoped!"
              echo "targetNamespaces: [$TARGET_NS]"
              echo "This is the root cause - cluster-scoped operators require targetNamespaces: []"
            fi
            echo ""
            echo "=== Subscription status ==="
            oc get subscription toolhive-operator -n ${{ env.OPERATOR_NS }} -o yaml
            echo ""
            echo "=== Subscription conditions ==="
            oc get subscription toolhive-operator -n ${{ env.OPERATOR_NS }} -o jsonpath='{.status.conditions[*]}' || true
            echo ""
            echo "=== Catalog-operator logs (check for catalog processing) ==="
            CATALOG_OP_POD=$(oc get pods -n olm -l app=catalog-operator -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
            if [ -n "$CATALOG_OP_POD" ]; then
              echo "Catalog-operator pod: $CATALOG_OP_POD"
              echo "Recent logs (last 50 lines, filtered for toolhive/catalog):"
              oc logs -n olm $CATALOG_OP_POD --tail=50 2>/dev/null | grep -i "toolhive\|catalog\|error\|failed" || echo "No relevant logs found"
            else
              echo "Catalog-operator pod not found"
            fi
            echo ""
            echo "=== CatalogSource status ==="
            oc get catalogsource toolhive-test-catalog -n openshift-marketplace -o yaml
            echo ""
            echo "=== Available operators in catalog ==="
            # Try to see what operators are available
            CATALOG_POD=$(oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
            if [ -n "$CATALOG_POD" ]; then
              echo "Catalog pod: $CATALOG_POD"
              echo "Checking catalog pod database location..."
              oc exec -n openshift-marketplace $CATALOG_POD -- ls -la /configs 2>/dev/null || echo "Could not list /configs"
              oc exec -n openshift-marketplace $CATALOG_POD -- ls -la /database 2>/dev/null || echo "Could not list /database"
              
              # CRITICAL: Verify catalog image contains operator using opm render
              echo ""
              echo "=== Verifying catalog image contains operator ==="
              # Install opm if not available
              if ! command -v opm &> /dev/null; then
                echo "Installing opm for verification..."
                OPM_VERSION=v1.35.0
                curl -L https://github.com/operator-framework/operator-registry/releases/download/${OPM_VERSION}/linux-amd64-opm -o /tmp/opm
                chmod +x /tmp/opm
                export PATH=/tmp:$PATH
              fi
              
              echo "Rendering catalog image: ${{ env.CATALOG_IMAGE }}"
              echo "This may take a moment (using timeout to prevent hanging)..."
              
              # Use timeout to prevent hanging, capture to file for reliability
              timeout 120 opm render ${{ env.CATALOG_IMAGE }} > /tmp/catalog-render-output.json 2>&1 || {
                EXIT_CODE=$?
                if [ $EXIT_CODE -eq 124 ]; then
                  echo "RENDER_TIMEOUT" > /tmp/catalog-render-output.json
                else
                  echo "RENDER_FAILED (exit code: $EXIT_CODE)" >> /tmp/catalog-render-output.json
                fi
              }
              
              RENDER_OUTPUT=$(cat /tmp/catalog-render-output.json 2>/dev/null || echo "FILE_READ_FAILED")
              
              # Always show some output for debugging
              echo "Render command completed. Output length: $(echo "$RENDER_OUTPUT" | wc -l) lines"
              
              # Check if render failed or timed out
              if echo "$RENDER_OUTPUT" | grep -q "RENDER_TIMEOUT"; then
                echo "✗ ERROR: opm render timed out after 120 seconds!"
                echo "This suggests the catalog image may be corrupted or very large."
                echo "First 50 lines of output before timeout:"
                head -50 /tmp/catalog-render-output.json 2>/dev/null || echo "No output captured"
                exit 1
              elif echo "$RENDER_OUTPUT" | grep -q "RENDER_FAILED\|FILE_READ_FAILED\|error\|Error\|ERROR\|failed to pull"; then
                echo "✗ ERROR: Failed to render catalog image!"
                echo "This is the root cause - the catalog image cannot be rendered."
                echo "Full render output:"
                cat /tmp/catalog-render-output.json 2>/dev/null || echo "Could not read output file"
                echo ""
                echo "Possible causes:"
                echo "1. Catalog image doesn't exist or is inaccessible"
                echo "2. Catalog image is corrupted"
                echo "3. Network issue pulling the image"
                exit 1
              elif echo "$RENDER_OUTPUT" | grep -qi "toolhive-operator"; then
                echo "✓ Catalog image contains toolhive-operator"
                echo "Sample output (first 10 lines with toolhive-operator):"
                echo "$RENDER_OUTPUT" | grep -i "toolhive-operator" | head -10
                echo ""
                echo "Full render output saved to /tmp/catalog-render-output.json"
                echo "First 50 lines of full output:"
                head -50 /tmp/catalog-render-output.json 2>/dev/null
              else
                echo "✗ ERROR: Catalog image does NOT contain toolhive-operator!"
                echo "This is the root cause - the catalog was built incorrectly."
                echo ""
                echo "Checking if catalog contains any OLM data..."
                if echo "$RENDER_OUTPUT" | grep -q "olm.package\|olm.bundle\|olm.channel"; then
                  echo "⚠ Catalog contains OLM data but not toolhive-operator"
                  echo "Packages found in catalog:"
                  echo "$RENDER_OUTPUT" | grep -o '"name": "[^"]*"' | head -20 || echo "Could not extract package names"
                else
                  echo "✗ Catalog does not contain valid OLM data!"
                fi
                echo ""
                echo "Full render output (first 200 lines):"
                head -200 /tmp/catalog-render-output.json 2>/dev/null || echo "Could not read output file"
                exit 1
              fi
              
              # Try to query the catalog pod's gRPC endpoint
              echo ""
              echo "=== Attempting to query catalog pod gRPC endpoint ==="
              CATALOG_SVC="toolhive-test-catalog.openshift-marketplace.svc:50051"
              echo "Catalog service: $CATALOG_SVC"
              
              # Check if we can reach the service
              echo "Checking if catalog service is reachable..."
              if oc get svc toolhive-test-catalog -n openshift-marketplace &>/dev/null; then
                echo "✓ Catalog service exists"
                SVC_IP=$(oc get svc toolhive-test-catalog -n openshift-marketplace -o jsonpath='{.spec.clusterIP}')
                echo "Service ClusterIP: $SVC_IP"
              else
                echo "✗ Catalog service not found!"
              fi
              
              # Check if grpcurl is available
              if command -v grpcurl &> /dev/null; then
                echo "Using grpcurl to query catalog..."
                GRPC_OUTPUT=$(grpcurl -plaintext -max-time 10 $CATALOG_SVC list 2>&1 || echo "GRPC_QUERY_FAILED")
                if echo "$GRPC_OUTPUT" | grep -q "GRPC_QUERY_FAILED\|connection refused\|deadline exceeded"; then
                  echo "✗ Could not query catalog via grpcurl"
                  echo "Error: $GRPC_OUTPUT"
                  echo ""
                  echo "This suggests the catalog pod is not serving gRPC correctly."
                else
                  echo "✓ gRPC query succeeded"
                  echo "Available services:"
                  echo "$GRPC_OUTPUT" | head -20
                fi
              else
                echo "grpcurl not available - installing..."
                curl -L https://github.com/fullstorydev/grpcurl/releases/download/v1.8.9/grpcurl_1.8.9_linux_x86_64.tar.gz -o /tmp/grpcurl.tar.gz 2>&1 | head -5
                tar -xzf /tmp/grpcurl.tar.gz -C /tmp grpcurl 2>&1 || echo "Failed to extract grpcurl"
                chmod +x /tmp/grpcurl
                GRPC_OUTPUT=$(/tmp/grpcurl -plaintext -max-time 10 $CATALOG_SVC list 2>&1 || echo "GRPC_QUERY_FAILED")
                if echo "$GRPC_OUTPUT" | grep -q "GRPC_QUERY_FAILED\|connection refused\|deadline exceeded"; then
                  echo "✗ Could not query catalog via grpcurl"
                  echo "Error: $GRPC_OUTPUT"
                else
                  echo "✓ gRPC query succeeded"
                  echo "$GRPC_OUTPUT" | head -20
                fi
              fi
              
              # Also check catalog pod logs for errors
              echo ""
              echo "=== Catalog pod logs (checking for errors) ==="
              if [ -n "$CATALOG_POD" ]; then
                echo "Recent catalog pod logs (last 30 lines):"
                oc logs -n openshift-marketplace $CATALOG_POD --tail=30 2>/dev/null || echo "Could not get catalog pod logs"
              fi
            fi
            
            echo ""
            echo "=== Checking if catalog-operator has discovered CatalogSource ==="
            if [ -n "$CATALOG_OP_POD" ]; then
              echo "Searching catalog-operator logs for toolhive-test-catalog..."
              # Use || true to prevent grep from causing script failure
              
              # CRITICAL: Check for CONNECTING state (this is the root cause!)
              if oc logs -n olm $CATALOG_OP_POD --tail=1000 2>/dev/null | grep -qi "toolhive-test-catalog.*CONNECTING\|state.*CONNECTING.*toolhive-test-catalog" || false; then
                echo "✗ CRITICAL: Catalog-operator is stuck in CONNECTING state!"
                echo ""
                echo "ROOT CAUSE: Catalog-operator is trying to connect to the catalog pod but cannot complete the connection."
                echo "This indicates catalog-operator cannot reach the catalog pod's gRPC endpoint."
                echo ""
                echo "Connection state logs:"
                oc logs -n olm $CATALOG_OP_POD --tail=1000 2>/dev/null | grep -i "toolhive-test-catalog.*state\|toolhive-test-catalog.*CONNECTING\|toolhive-test-catalog.*connect" | tail -10 || true
                echo ""
                echo "SOLUTION: The catalog pod may not be reachable from catalog-operator due to:"
                echo "1. DNS not resolving from within the cluster"
                echo "2. Network policy blocking traffic between namespaces"
                echo "3. Catalog pod not responding to gRPC queries"
                echo "4. Service endpoint not properly configured"
                echo ""
                echo "Attempting to verify connectivity..."
                
                # Check if catalog pod is reachable
                CATALOG_POD=$(oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
                if [ -n "$CATALOG_POD" ]; then
                  echo "Catalog pod: $CATALOG_POD"
                  echo "Testing connectivity from catalog-operator pod..."
                  # Try to test connectivity (nc may not be available, but worth trying)
                  oc exec -n olm $CATALOG_OP_POD -- sh -c "timeout 5 nc -zv toolhive-test-catalog.openshift-marketplace.svc 50051 2>&1 || echo 'Connection test failed (nc may not be available)'" 2>/dev/null || {
                    echo "⚠ Could not test connectivity directly"
                  }
                  
                  # Check Service endpoint
                  echo ""
                  echo "Checking Service endpoint configuration..."
                  oc get svc toolhive-test-catalog -n openshift-marketplace -o yaml | grep -A 5 "spec:" || true
                  oc get endpoints toolhive-test-catalog -n openshift-marketplace -o yaml || true
                fi
              elif oc logs -n olm $CATALOG_OP_POD --tail=500 2>/dev/null | grep -qi "toolhive-test-catalog.*READY\|toolhive-test-catalog.*state.*READY\|toolhive-test-catalog.*connected" || false; then
                echo "✓ Catalog-operator has successfully connected to toolhive-test-catalog (READY state)"
                echo "Recent connection logs:"
                oc logs -n olm $CATALOG_OP_POD --tail=500 2>/dev/null | grep -i "toolhive-test-catalog.*READY\|toolhive-test-catalog.*state\|toolhive-test-catalog" | tail -5 || true
              elif oc logs -n olm $CATALOG_OP_POD --tail=500 2>/dev/null | grep -qi "toolhive-test-catalog" || false; then
                echo "⚠ Found toolhive-test-catalog in catalog-operator logs but connection state unclear"
                echo "Recent mentions:"
                oc logs -n olm $CATALOG_OP_POD --tail=500 2>/dev/null | grep -i "toolhive-test-catalog" | tail -5 || true
                echo ""
                echo "Checking for connection state information..."
                oc logs -n olm $CATALOG_OP_POD --tail=1000 2>/dev/null | grep -i "toolhive-test-catalog.*state\|toolhive-test-catalog.*connect" | tail -10 || true
              else
                echo "✗ ERROR: catalog-operator has NOT discovered toolhive-test-catalog!"
                echo "This is the root cause - catalog-operator is not aware of the CatalogSource."
                echo ""
                echo "CRITICAL INSIGHT: Catalog-operator logs show it's trying to resolve subscriptions"
                echo "with source=toolhive-test-catalog, but it's saying 'no operators found'."
                echo "This means catalog-operator knows about the catalog name but hasn't queried"
                echo "the catalog pod's gRPC endpoint to discover operators."
                echo ""
                echo "Recent catalog-operator logs (showing what it IS processing):"
                oc logs -n olm $CATALOG_OP_POD --tail=100 2>/dev/null | grep -i "catalog\|source\|resolve" | tail -10 || true
                echo ""
                echo "SOLUTION: Catalog-operator needs to query the catalog pod's gRPC endpoint."
                echo "This may require:"
                echo "1. Restarting catalog-operator to force re-discovery"
                echo "2. Ensuring CatalogSource is in a namespace catalog-operator watches"
                echo "3. Verifying catalog pod is serving operators correctly via gRPC"
              fi
            fi
            
            # CRITICAL: Check if catalog-operator can actually query the catalog pod
            echo ""
            echo "=== Verifying catalog-operator can query catalog pod ==="
            CATALOG_POD=$(oc get pods -n openshift-marketplace -l olm.catalogSource=toolhive-test-catalog -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
            if [ -n "$CATALOG_POD" ]; then
              echo "Catalog pod: $CATALOG_POD"
              echo "Checking if catalog-operator has any connection errors to this pod..."
              if [ -n "$CATALOG_OP_POD" ]; then
                # Look for connection errors, timeouts, or query failures
                CONNECTION_ERRORS=$(oc logs -n olm $CATALOG_OP_POD --tail=1000 2>/dev/null | grep -i "toolhive-test-catalog.*error\|toolhive-test-catalog.*fail\|toolhive-test-catalog.*timeout\|toolhive-test-catalog.*connect\|UpdateStatus.*error.*toolhive-test-catalog" || echo "")
                if [ -n "$CONNECTION_ERRORS" ]; then
                  echo "✗ Found connection errors:"
                  echo "$CONNECTION_ERRORS" | tail -10
                else
                  echo "No connection errors found for toolhive-test-catalog"
                  echo "This suggests catalog-operator may not be attempting to connect at all"
                fi
              fi
            fi
            echo ""
            echo "=== Catalog-operator full logs (last 100 lines) ==="
            if [ -n "$CATALOG_OP_POD" ]; then
              oc logs -n olm $CATALOG_OP_POD --tail=100 2>/dev/null | tail -50
            fi
            echo ""
            echo "=== CatalogSource full status ==="
            oc get catalogsource toolhive-test-catalog -n openshift-marketplace -o yaml
            echo ""
            echo "=== Rendered OperatorGroup (for comparison) ==="
            grep -A 15 "kind: OperatorGroup" temp-manifests/olm-resources.yaml || echo "OperatorGroup not found in rendered manifests"
            echo ""
            echo "=== Possible Root Causes ==="
            echo "1. Catalog-operator hasn't queried the catalog pod yet"
            echo "2. Catalog pod's database doesn't contain the operator"
            echo "3. Catalog-operator's internal cache is stale"
            echo "4. Catalog image doesn't actually contain the operator (but build workflow verified it does)"
            echo ""
            echo "=== Recommended Actions ==="
            echo "1. Check if catalog pod database exists and has content"
            echo "2. Verify catalog image using: opm render ${{ env.CATALOG_IMAGE }}"
            echo "3. Check catalog-operator logs for query errors"
            echo "4. Try deleting and recreating the Subscription to force re-resolution"
            exit 1
          fi
          
          # Now wait for InstallPlan to complete
          if ! timeout 300 bash -c 'until oc get installplan -n ${{ env.OPERATOR_NS }} -l "operators.coreos.com/toolhive-operator.${{ env.OPERATOR_NS }}" 2>/dev/null | grep -q Complete; do sleep 5; done'; then
            echo "ERROR: InstallPlan did not complete"
            echo "=== InstallPlan status ==="
            oc get installplan -n ${{ env.OPERATOR_NS }} -o yaml
            echo "=== InstallPlan describe ==="
            oc describe installplan -n ${{ env.OPERATOR_NS }} -l "operators.coreos.com/toolhive-operator.${{ env.OPERATOR_NS }}" || true
            echo "=== Subscription status ==="
            oc get subscription -n ${{ env.OPERATOR_NS }} -o yaml
            echo "=== Subscription conditions ==="
            oc get subscription toolhive-operator -n ${{ env.OPERATOR_NS }} -o jsonpath='{.status.conditions[*]}' || true
            echo ""
            exit 1
          fi
          echo "InstallPlan completed"
          
          echo "Waiting for CSV to be Succeeded (OKD OLM)..."
          if ! oc wait --for=jsonpath='{.status.phase}'=Succeeded \
            csv -n ${{ env.OPERATOR_NS }} \
            -l "operators.coreos.com/toolhive-operator.${{ env.OPERATOR_NS }}" \
            --timeout=${{ env.TEST_TIMEOUT }}; then
            echo "ERROR: CSV did not reach Succeeded phase"
            echo "CSV status:"
            oc get csv -n ${{ env.OPERATOR_NS }} -o yaml
            echo "CSV conditions:"
            oc get csv -n ${{ env.OPERATOR_NS }} -o jsonpath='{.items[*].status.conditions}' || true
            exit 1
          fi
          echo "CSV is Succeeded"
          
          echo "Waiting for operator deployment..."
          if ! oc wait --for=condition=available \
            deployment/toolhive-operator -n ${{ env.OPERATOR_NS }} \
            --timeout=${{ env.TEST_TIMEOUT }}; then
            echo "ERROR: Operator deployment did not become available"
            echo "Deployment status:"
            oc get deployment toolhive-operator -n ${{ env.OPERATOR_NS }} -o yaml
            echo "Deployment pods:"
            oc get pods -n ${{ env.OPERATOR_NS }} -l name=toolhive-operator
            echo "Pod logs:"
            oc logs -n ${{ env.OPERATOR_NS }} -l name=toolhive-operator --tail=50 || true
            exit 1
          fi
          echo "Operator deployment is available"
      
      # Phase 6: Declarative Validation and Testing (Chainsaw)
      - name: Run Chainsaw tests
        run: |
          set -e
          export KUBECONFIG=${HOME}/.kube/config
          echo "Running Chainsaw tests in namespace: ${{ env.OPERATOR_NS }}"
          if ! chainsaw test --test-dir ./test-suites --namespace ${{ env.OPERATOR_NS }}; then
            echo "ERROR: Chainsaw tests failed"
            echo "Collecting diagnostic information (OKD-compatible)..."
            oc get all -n ${{ env.OPERATOR_NS }}
            oc get mcpserver -n ${{ env.OPERATOR_NS }} || true
            exit 1
          fi
          echo "All Chainsaw tests passed"
      
      # Phase 7: Cleanup
      - name: Collect diagnostics on failure
        if: failure()
        run: |
          echo "=== Collecting diagnostic information (OKD-compatible) ==="
          echo "--- Cluster state ---"
          oc get all -A | grep -E "(toolhive|olm)" || true
          echo "--- OLM resources (OKD standard) ---"
          oc get catalogsource,subscription,operatorgroup,csv -A || true
          echo "--- Operator logs ---"
          oc logs -n ${{ env.OPERATOR_NS }} -l name=toolhive-operator --tail=100 || true
          echo "--- Events ---"
          oc get events -n ${{ env.OPERATOR_NS }} --sort-by='.lastTimestamp' | tail -20 || true
          echo "=== End diagnostics ==="
      
      - name: Cleanup OLM resources (OKD-compatible)
        if: always()
        run: |
          set +e
          echo "Cleaning up OLM resources (OKD-compatible)..."
          oc delete subscription toolhive-operator -n ${{ env.OPERATOR_NS }} --ignore-not-found=true || true
          oc delete operatorgroup toolhive-operator-group -n ${{ env.OPERATOR_NS }} --ignore-not-found=true || true
          oc delete catalogsource toolhive-test-catalog -n openshift-marketplace --ignore-not-found=true || true
          oc delete namespace ${{ env.OPERATOR_NS }} --ignore-not-found=true || true
          echo "Cleanup completed"
      
      - name: Delete KIND cluster
        if: always()
        run: |
          set +e
          kind delete cluster --name ${{ env.CLUSTER_NAME }} || true
          echo "KIND cluster deleted"

