name: Build Catalog Image

on:
  workflow_dispatch:
    inputs:
      operator_bundle_image:
        description: 'Operator bundle image to include in catalog'
        required: false
        default: 'quay.io/okderators/toolhive-operator-bundle:v0.3.5'
      catalog_image:
        description: 'Catalog image to build and push'
        required: false
        default: 'quay.io/kpais/toolhive-test-catalog:latest'
      channel:
        description: 'Channel name for the operator'
        required: false
        default: 'stable'
  push:
    paths:
      - '.github/workflows/build-catalog.yaml'
      - 'catalog/**'
  schedule:
    # Run daily to rebuild catalog with latest bundles
    - cron: '0 0 * * *'

env:
  OPERATOR_BUNDLE_IMAGE: ${{ github.event.inputs.operator_bundle_image || 'quay.io/okderators/toolhive-operator-bundle:v0.3.5' }}
  CATALOG_IMAGE: ${{ github.event.inputs.catalog_image || 'quay.io/kpais/toolhive-test-catalog:latest' }}
  CHANNEL: ${{ github.event.inputs.channel || 'stable' }}
  REGISTRY: quay.io
  # Use QUAY_IO_USERNAME secret if set (for robot accounts like kpais+buildcatalogbot)
  # Otherwise defaults to kpais
  REGISTRY_USER: ${{ secrets.QUAY_IO_USERNAME || 'kpais' }}

jobs:
  build-catalog:
    name: Build Catalog Image
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64
      
      - name: Log in to Quay.io
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ secrets.QUAY_IO_TOKEN }}
        continue-on-error: false
      
      - name: Verify authentication and provide troubleshooting
        if: failure()
        run: |
          echo ""
          echo "=========================================="
          echo "Quay.io Authentication Failed"
          echo "=========================================="
          echo ""
          echo "The workflow failed to authenticate with Quay.io."
          echo ""
          echo "Current configuration:"
          echo "  Registry: ${{ env.REGISTRY }}"
          echo "  Username: ${{ env.REGISTRY_USER }}"
          echo ""
          echo "Possible causes:"
          echo "  1. QUAY_IO_TOKEN secret is not set in GitHub repository settings"
          echo "  2. QUAY_IO_TOKEN secret is invalid or expired"
          echo "  3. Username is incorrect (if using robot account, set QUAY_IO_USERNAME secret)"
          echo ""
          echo "=========================================="
          echo "Solution:"
          echo "=========================================="
          echo ""
          echo "Step 1: Create Quay.io Token"
          echo "  - Go to https://quay.io"
          echo "  - Sign in → Account Settings → Applications"
          echo "  - Create Application Token with Read & Write permissions"
          echo "  - Copy the token (shown only once!)"
          echo ""
          echo "Step 2: Add Token to GitHub Secrets"
          echo "  - Go to: https://github.com/kenjpais/toolhive-onboarder/settings/secrets/actions"
          echo "  - Click 'New repository secret'"
          echo "  - Name: QUAY_IO_TOKEN"
          echo "  - Value: Paste the token from Step 1"
          echo "  - Click 'Add secret'"
          echo ""
          echo "Step 3: (Optional) If using Robot Account"
          echo "  - Also add QUAY_IO_USERNAME secret"
          echo "  - Value: Your robot account username (e.g., kpais+buildcatalogbot)"
          echo ""
          echo "Step 4: Re-run the workflow"
          echo "  - Go to Actions → Build Catalog Image → Run workflow"
          echo ""
          echo "For detailed instructions, see: CATALOG_BUILD.md"
          echo "=========================================="
      
      - name: Install opm CLI
        run: |
          set -e
          echo "Installing opm CLI..."
          OPM_VERSION=v1.35.0
          curl -L https://github.com/operator-framework/operator-registry/releases/download/${OPM_VERSION}/linux-amd64-opm -o /usr/local/bin/opm
          chmod +x /usr/local/bin/opm
          opm version
          echo "opm CLI installed successfully"
      
      - name: Verify operator bundle image exists
        run: |
          set -e
          echo "Verifying operator bundle image: ${{ env.OPERATOR_BUNDLE_IMAGE }}"
          # Check if image exists and is accessible
          docker pull ${{ env.OPERATOR_BUNDLE_IMAGE }} || {
            echo "ERROR: Failed to pull operator bundle image: ${{ env.OPERATOR_BUNDLE_IMAGE }}"
            echo "Please ensure the bundle image exists and is accessible"
            exit 1
          }
          echo "Operator bundle image verified"
          
          # CRITICAL: Verify architecture is amd64 (required for KIND and GitHub CI)
          echo "Checking bundle image architecture..."
          ARCH=$(docker inspect ${{ env.OPERATOR_BUNDLE_IMAGE }} --format '{{.Architecture}}' || echo "unknown")
          echo "Bundle image architecture: $ARCH"
          if [ "$ARCH" != "amd64" ] && [ "$ARCH" != "x86_64" ]; then
            echo ""
            echo "=========================================="
            echo "ERROR: Bundle image architecture mismatch!"
            echo "=========================================="
            echo "Bundle image: ${{ env.OPERATOR_BUNDLE_IMAGE }}"
            echo "Detected architecture: $ARCH"
            echo "Required architecture: amd64/x86_64 (for KIND and GitHub CI)"
            echo ""
            echo "The bundle image must be built for linux/amd64 architecture."
            echo "KIND clusters and GitHub Actions runners use AMD64 architecture."
            echo ""
            echo "Solution:"
            echo "  1. Rebuild the bundle image for linux/amd64 platform"
            echo "  2. Push the amd64 version to the registry"
            echo "  3. Ensure the image tag supports multi-arch or is amd64-only"
            echo ""
            echo "Example build command:"
            echo "  docker buildx build --platform linux/amd64 \\"
            echo "    -t quay.io/okderators/toolhive-operator-bundle:v0.3.5 \\"
            echo "    --push ."
            echo "=========================================="
            exit 1
          fi
          echo "✓ Bundle image architecture is compatible (amd64/x86_64)"
          
          # Verify bundle contains operator metadata
          echo "Verifying bundle image contains operator metadata..."
          MANIFESTS_FOUND=false
          if docker run --rm --platform linux/amd64 --entrypoint /bin/sh ${{ env.OPERATOR_BUNDLE_IMAGE }} -c "test -d /manifests && ls /manifests/*.yaml 2>/dev/null | head -1" 2>/dev/null; then
            echo "✓ Bundle contains manifests directory at /manifests"
            MANIFESTS_FOUND=true
          elif docker run --rm --platform linux/amd64 --entrypoint /bin/sh ${{ env.OPERATOR_BUNDLE_IMAGE }} -c "test -d /bundle/manifests && ls /bundle/manifests/*.yaml 2>/dev/null | head -1" 2>/dev/null; then
            echo "✓ Bundle contains manifests directory at /bundle/manifests"
            MANIFESTS_FOUND=true
          else
            echo "WARNING: Could not verify bundle manifests directory"
            echo "Checking bundle image contents:"
            docker run --rm --platform linux/amd64 --entrypoint /bin/sh ${{ env.OPERATOR_BUNDLE_IMAGE }} -c "ls -la /" 2>/dev/null | head -20 || true
          fi
          
          # CRITICAL: Verify bundle contains toolhive-operator package using opm
          echo "Verifying bundle contains 'toolhive-operator' package..."
          if opm alpha bundle validate ${{ env.OPERATOR_BUNDLE_IMAGE }} 2>&1 | grep -q "toolhive-operator"; then
            echo "✓ Bundle contains toolhive-operator package"
          elif opm render ${{ env.OPERATOR_BUNDLE_IMAGE }} 2>&1 | grep -q "toolhive-operator"; then
            echo "✓ Bundle contains toolhive-operator package (verified via opm render)"
          else
            echo "WARNING: Could not verify toolhive-operator package name in bundle"
            echo "Attempting to list bundle contents:"
            opm render ${{ env.OPERATOR_BUNDLE_IMAGE }} 2>&1 | head -20 || echo "Could not render bundle"
            echo ""
            echo "Note: The bundle will be added to catalog, but package name verification failed."
            echo "If the package name is not 'toolhive-operator', the subscription will fail to resolve."
          fi
      
      - name: Generate catalog index
        run: |
          set -e
          echo "Generating catalog index..."
          
          # Generate the catalog index
          # opm index add --generate creates catalog-index.Dockerfile and database/index.db
          opm index add \
            --bundles ${{ env.OPERATOR_BUNDLE_IMAGE }} \
            --tag ${{ env.CATALOG_IMAGE }} \
            --binary-image quay.io/operator-framework/opm:v1.35.0 \
            --mode semver \
            --generate
          
          echo "Catalog index generated"
          echo "Generated files:"
          ls -la catalog-index.Dockerfile 2>/dev/null || ls -la *.Dockerfile 2>/dev/null || find . -name "*.Dockerfile" -type f
          ls -la database/ 2>/dev/null || echo "Database directory not found"
          
          # CRITICAL: Verify database exists and contains data
          if [ ! -f "database/index.db" ]; then
            echo "ERROR: database/index.db not found after opm index add!"
            echo "This means the catalog index generation failed"
            exit 1
          fi
          
          echo "✓ Catalog database found: database/index.db"
          ls -lh database/index.db
          
          # Verify the database contains operator data by checking its size
          DB_SIZE=$(stat -f%z database/index.db 2>/dev/null || stat -c%s database/index.db 2>/dev/null || echo "0")
          if [ "$DB_SIZE" -lt 1000 ]; then
            echo "ERROR: Catalog database is too small ($DB_SIZE bytes) - likely empty!"
            echo "The operator bundle may not have been added to the catalog"
            exit 1
          fi
          echo "✓ Catalog database size: $DB_SIZE bytes (contains data)"
          
          # Note: We skip database content verification here because:
          # 1. opm list command is deprecated/removed in newer opm versions
          # 2. Building a temporary image for verification is complex and may fail
          # 3. We verify the final catalog image after it's built and pushed (more reliable)
          # 
          # The database size check above (${DB_SIZE} bytes) is a good indicator that
          # the catalog has content. The final verification step will confirm the operator
          # is actually in the catalog image.
          echo "✓ Catalog database verification complete"
          echo "  - Database exists: database/index.db"
          echo "  - Database size: ${DB_SIZE} bytes (contains data)"
          echo "  - Final catalog image will be verified after build and push"
      
      - name: Build and push catalog image
        run: |
          set -e
          echo "Building catalog image for linux/amd64 architecture..."
          
          # Find the generated Dockerfile
          # opm index add --generate creates index.Dockerfile (not catalog-index.Dockerfile)
          DOCKERFILE="index.Dockerfile"
          if [ ! -f "$DOCKERFILE" ]; then
            # Try alternative names
            DOCKERFILE="catalog-index.Dockerfile"
            if [ ! -f "$DOCKERFILE" ]; then
              # Find any Dockerfile in current directory
              DOCKERFILE=$(find . -maxdepth 1 -name "*.Dockerfile" -type f | head -1)
            if [ -z "$DOCKERFILE" ]; then
                echo "ERROR: Could not find generated Dockerfile"
                echo "Expected: index.Dockerfile or catalog-index.Dockerfile"
                echo "Files in current directory:"
                ls -la *.Dockerfile 2>/dev/null || echo "No Dockerfile found"
              exit 1
              fi
            fi
          fi
          
          echo "Using Dockerfile: $DOCKERFILE"
          echo "Dockerfile location: $(pwd)/$DOCKERFILE"
          
          # Build the catalog image with explicit platform
          docker buildx build \
            --platform linux/amd64 \
            --tag ${{ env.CATALOG_IMAGE }} \
            --file "$DOCKERFILE" \
            --push \
            .
          
          echo "Catalog image built and pushed successfully"
      
      - name: Verify catalog image architecture
        run: |
          set -e
          echo "Verifying catalog image architecture..."
          
          # Pull the image to verify
          docker pull ${{ env.CATALOG_IMAGE }}
          
          # Check architecture
          ARCH=$(docker inspect ${{ env.CATALOG_IMAGE }} --format '{{.Architecture}}' || echo "unknown")
          echo "Catalog image architecture: $ARCH"
          
          if [ "$ARCH" != "amd64" ] && [ "$ARCH" != "x86_64" ]; then
            echo "ERROR: Catalog image architecture is $ARCH, expected amd64/x86_64"
            exit 1
          fi
          
          # Note: The catalog image is based on a distroless image (opm:v1.35.0) which doesn't have /bin/sh
          # We cannot run shell commands inside the container. Instead, we verify the catalog by:
          # 1. Checking architecture (done above)
          # 2. Using opm render to verify catalog contents (done below - most reliable)
          
          # Verify catalog database exists by checking image layers
          echo "Verifying catalog database exists in image..."
          # The database should be in /database/index.db based on the Dockerfile
          # We can't run shell commands, but opm render will fail if database is missing
          echo "✓ Image architecture verified (amd64)"
          echo "  Database existence will be verified via opm render (below)"
          
          # CRITICAL: Verify we can render the catalog and it contains the operator
          echo "Verifying catalog can be rendered and contains 'toolhive-operator'..."
          echo "Rendering catalog image: ${{ env.CATALOG_IMAGE }}"
          RENDER_OUTPUT=$(opm render ${{ env.CATALOG_IMAGE }} 2>&1)
          RENDER_EXIT_CODE=$?
          
          if [ $RENDER_EXIT_CODE -ne 0 ]; then
            echo "ERROR: Failed to render catalog image!"
            echo "Exit code: $RENDER_EXIT_CODE"
            echo "opm render output:"
            echo "$RENDER_OUTPUT"
            exit 1
          fi
          
          echo "opm render succeeded. Output length: $(echo "$RENDER_OUTPUT" | wc -l) lines"
          echo "First 30 lines of render output:"
          echo "$RENDER_OUTPUT" | head -30
          echo ""
          
          if echo "$RENDER_OUTPUT" | grep -qE '"package"\s*:\s*"toolhive-operator"|"packageName"\s*:\s*"toolhive-operator"|"name"\s*:\s*"toolhive-operator"|toolhive-operator'; then
            echo "✓ Catalog contains 'toolhive-operator' package!"
            echo "Sample catalog content:"
            echo "$RENDER_OUTPUT" | grep -i "toolhive-operator\|package" | head -10
          elif echo "$RENDER_OUTPUT" | head -5 | grep -q "olm.package\|olm.bundle\|olm.channel"; then
            echo "WARNING: Catalog contains OLM data but 'toolhive-operator' not found!"
            echo "Catalog contents (first 50 lines):"
            echo "$RENDER_OUTPUT" | head -50
            echo ""
            echo "ERROR: Catalog image does not contain 'toolhive-operator' package!"
            echo "This indicates the bundle was not added to the catalog."
            echo "Please check:"
            echo "  1. The bundle image exists and is accessible: ${{ env.OPERATOR_BUNDLE_IMAGE }}"
            echo "  2. The bundle image contains valid operator metadata"
            echo "  3. The bundle package name matches 'toolhive-operator'"
            exit 1
          else
            echo "ERROR: Catalog image does not contain valid OLM catalog data!"
            echo "opm render output:"
            echo "$RENDER_OUTPUT" | head -20
            exit 1
          fi
          
          echo "Catalog image verification complete - image contains valid catalog data"
      
      - name: Display catalog image info
        run: |
          set -e
          echo "=== Catalog Image Information ==="
          echo "Image: ${{ env.CATALOG_IMAGE }}"
          echo "Architecture: $(docker inspect ${{ env.CATALOG_IMAGE }} --format '{{.Architecture}}')"
          echo "Size: $(docker inspect ${{ env.CATALOG_IMAGE }} --format '{{.Size}}' | numfmt --to=iec-i --suffix=B)"
          echo "Created: $(docker inspect ${{ env.CATALOG_IMAGE }} --format '{{.Created}}')"
          echo "================================"

