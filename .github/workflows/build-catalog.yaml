name: Build Catalog Image

on:
  workflow_dispatch:
    inputs:
      operator_bundle_image:
        description: 'Operator bundle image to include in catalog'
        required: false
        default: 'quay.io/okderators/toolhive-operator-bundle:v0.3.5'
      catalog_image:
        description: 'Catalog image to build and push'
        required: false
        default: 'quay.io/kpais/toolhive-test-catalog:latest'
      channel:
        description: 'Channel name for the operator'
        required: false
        default: 'stable'
  push:
    branches: [main, master]
    paths:
      - '.github/workflows/build-catalog.yaml'
      - 'catalog/**'
  schedule:
    # Run daily to rebuild catalog with latest bundles
    - cron: '0 0 * * *'

env:
  OPERATOR_BUNDLE_IMAGE: ${{ github.event.inputs.operator_bundle_image || 'quay.io/okderators/toolhive-operator-bundle:v0.3.5' }}
  CATALOG_IMAGE: ${{ github.event.inputs.catalog_image || 'quay.io/kpais/toolhive-test-catalog:latest' }}
  CHANNEL: ${{ github.event.inputs.channel || 'stable' }}
  REGISTRY: quay.io
  # Use QUAY_IO_USERNAME secret if set (for robot accounts like kpais+buildcatalogbot)
  # Otherwise defaults to kpais
  REGISTRY_USER: ${{ secrets.QUAY_IO_USERNAME || 'kpais' }}

jobs:
  build-catalog:
    name: Build Catalog Image
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64
      
      - name: Log in to Quay.io
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ secrets.QUAY_IO_TOKEN }}
      
      - name: Install opm CLI
        run: |
          set -e
          echo "Installing opm CLI..."
          OPM_VERSION=v1.35.0
          curl -L https://github.com/operator-framework/operator-registry/releases/download/${OPM_VERSION}/linux-amd64-opm -o /usr/local/bin/opm
          chmod +x /usr/local/bin/opm
          opm version
          echo "opm CLI installed successfully"
      
      - name: Verify operator bundle image exists
        run: |
          set -e
          echo "Verifying operator bundle image: ${{ env.OPERATOR_BUNDLE_IMAGE }}"
          # Check if image exists and is accessible
          docker pull ${{ env.OPERATOR_BUNDLE_IMAGE }} || {
            echo "ERROR: Failed to pull operator bundle image: ${{ env.OPERATOR_BUNDLE_IMAGE }}"
            echo "Please ensure the bundle image exists and is accessible"
            exit 1
          }
          echo "Operator bundle image verified"
          
          # Verify architecture
          echo "Checking bundle image architecture..."
          ARCH=$(docker inspect ${{ env.OPERATOR_BUNDLE_IMAGE }} --format '{{.Architecture}}' || echo "unknown")
          echo "Bundle image architecture: $ARCH"
          if [ "$ARCH" != "amd64" ] && [ "$ARCH" != "x86_64" ]; then
            echo "WARNING: Bundle image architecture is $ARCH, expected amd64/x86_64"
          fi
      
      - name: Generate catalog index
        run: |
          set -e
          echo "Generating catalog index..."
          
          # Create a directory for the catalog
          mkdir -p catalog-index
          cd catalog-index
          
          # Generate the catalog index using opm index add
          # This creates database/index.db with the operator bundle
          opm index add \
            --bundles ${{ env.OPERATOR_BUNDLE_IMAGE }} \
            --binary-image quay.io/operator-framework/opm:v1.35.0 \
            --mode semver \
            --generate
          
          cd ..
          
          echo "Catalog index generated"
          echo "Generated files:"
          ls -la catalog-index/ 2>/dev/null || echo "catalog-index directory not found"
          ls -la catalog-index/catalog-index.Dockerfile 2>/dev/null || ls -la catalog-index/*.Dockerfile 2>/dev/null || find catalog-index -name "*.Dockerfile" -type f
          ls -la catalog-index/database/ 2>/dev/null || echo "Database directory not found"
          
          # Verify database exists
          if [ ! -f "catalog-index/database/index.db" ]; then
            echo "ERROR: catalog-index/database/index.db not found!"
            echo "Contents of catalog-index:"
            find catalog-index -type f | head -20
            exit 1
          fi
          
          echo "✓ Catalog database found: catalog-index/database/index.db"
          ls -lh catalog-index/database/index.db
      
      - name: Build and push catalog image
        run: |
          set -e
          echo "Building catalog image for linux/amd64 architecture..."
          
          # Verify the database exists before building
          if [ ! -f "catalog-index/database/index.db" ]; then
            echo "ERROR: database/index.db not found in catalog-index directory"
            echo "Cannot build catalog image without database"
            exit 1
          fi
          
          # Find the generated Dockerfile
          # opm index add --generate creates catalog-index.Dockerfile in the current directory
          # Since we ran it in catalog-index/, the Dockerfile should be at catalog-index/catalog-index.Dockerfile
          DOCKERFILE="catalog-index/catalog-index.Dockerfile"
          if [ ! -f "$DOCKERFILE" ]; then
            # Try to find any Dockerfile
            DOCKERFILE=$(find catalog-index -name "*.Dockerfile" -type f | head -1)
            if [ -z "$DOCKERFILE" ]; then
              echo "ERROR: Could not find generated Dockerfile in catalog-index"
              echo "Contents of catalog-index:"
              ls -la catalog-index/ || true
              exit 1
            fi
          fi
          
          echo "Using Dockerfile: $DOCKERFILE"
          echo "Dockerfile location relative to workspace: $DOCKERFILE"
          echo "Dockerfile contents (first 30 lines):"
          head -30 "$DOCKERFILE" || true
          
          # The Dockerfile generated by opm index add --generate expects:
          # - database/ directory in the same directory as the Dockerfile
          # - Build context should be the directory containing both Dockerfile and database/
          #
          # Since we ran opm in catalog-index/, the structure is:
          #   catalog-index/
          #     catalog-index.Dockerfile
          #     database/
          #       index.db
          #
          # Build context: catalog-index/ (so COPY database/ works)
          # Dockerfile: catalog-index/catalog-index.Dockerfile (relative to workspace root)
          
          # Change to catalog-index directory to build from there
          # This ensures paths in the Dockerfile work correctly
          cd catalog-index
          
          # Build the catalog image with explicit platform
          # Build context: . (current directory, which is catalog-index/)
          # Dockerfile: catalog-index.Dockerfile (in current directory)
          docker buildx build \
            --platform linux/amd64 \
            --tag ${{ env.CATALOG_IMAGE }} \
            --file catalog-index.Dockerfile \
            --push \
            .
          
          cd ..
          
          echo "Catalog image built and pushed successfully"
      
      - name: Verify catalog image architecture and content
        run: |
          set -e
          echo "Verifying catalog image architecture and content..."
          
          # Pull the image to verify
          docker pull ${{ env.CATALOG_IMAGE }}
          
          # Check architecture
          ARCH=$(docker inspect ${{ env.CATALOG_IMAGE }} --format '{{.Architecture}}' || echo "unknown")
          echo "Catalog image architecture: $ARCH"
          
          if [ "$ARCH" != "amd64" ] && [ "$ARCH" != "x86_64" ]; then
            echo "ERROR: Catalog image architecture is $ARCH, expected amd64/x86_64"
            exit 1
          fi
          
          # Verify opm binary in the image
          echo "Verifying opm binary in catalog image..."
          docker run --rm --platform linux/amd64 --entrypoint /bin/sh ${{ env.CATALOG_IMAGE }} -c "file /bin/opm || file /usr/bin/opm || find / -name opm -type f 2>/dev/null | head -1 | xargs file" || {
            echo "WARNING: Could not verify opm binary, but image was built successfully"
          }
          
          # CRITICAL: Verify catalog database exists in the image
          echo "Verifying catalog database exists in image..."
          if docker run --rm --platform linux/amd64 --entrypoint /bin/sh ${{ env.CATALOG_IMAGE }} -c "test -f /database/index.db && echo 'Database found at /database/index.db'" 2>/dev/null; then
            echo "✓ Catalog database found at /database/index.db"
          elif docker run --rm --platform linux/amd64 --entrypoint /bin/sh ${{ env.CATALOG_IMAGE }} -c "test -f /configs/index.db && echo 'Database found at /configs/index.db'" 2>/dev/null; then
            echo "✓ Catalog database found at /configs/index.db"
          else
            echo "ERROR: Catalog database NOT found in image!"
            echo "Checking what files exist in the image:"
            docker run --rm --platform linux/amd64 --entrypoint /bin/sh ${{ env.CATALOG_IMAGE }} -c "find / -name '*.db' -type f 2>/dev/null || echo 'No .db files found'" || true
            echo "Listing /database and /configs directories:"
            docker run --rm --platform linux/amd64 --entrypoint /bin/sh ${{ env.CATALOG_IMAGE }} -c "ls -la /database /configs 2>/dev/null || echo 'Directories not found'" || true
            exit 1
          fi
          
          # Verify we can render the catalog (this confirms it has actual catalog data)
          echo "Verifying catalog can be rendered (contains actual catalog data)..."
          if opm render ${{ env.CATALOG_IMAGE }} 2>&1 | head -5 | grep -q "olm.package\|olm.bundle\|olm.channel"; then
            echo "✓ Catalog contains OLM data (can be rendered)"
            echo "Sample catalog content:"
            opm render ${{ env.CATALOG_IMAGE }} 2>&1 | head -10
          else
            echo "ERROR: Catalog image does not contain valid OLM catalog data!"
            echo "opm render output:"
            opm render ${{ env.CATALOG_IMAGE }} 2>&1 | head -20
            exit 1
          fi
          
          echo "Catalog image verification complete - image contains valid catalog data"
      
      - name: Display catalog image info
        run: |
          set -e
          echo "=== Catalog Image Information ==="
          echo "Image: ${{ env.CATALOG_IMAGE }}"
          echo "Architecture: $(docker inspect ${{ env.CATALOG_IMAGE }} --format '{{.Architecture}}')"
          echo "Size: $(docker inspect ${{ env.CATALOG_IMAGE }} --format '{{.Size}}' | numfmt --to=iec-i --suffix=B)"
          echo "Created: $(docker inspect ${{ env.CATALOG_IMAGE }} --format '{{.Created}}')"
          echo "================================"

